<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>RuaPhone</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css?v=1.0.3">
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
</head>
<body>
    <div class="phone-frame" x-data="phoneApp()" x-init="init()">
        <!-- Status Bar -->
        <div class="status-bar">
            <div x-text="currentTime"></div>
            <div class="battery">
                <span x-text="batteryLevel + '%'"></span>
                <div class="battery-icon">
                    <div class="battery-level" :style="`width: ${batteryLevel}%`"></div>
                </div>
            </div>
        </div>

        <!-- Screen Content -->
        <div class="screen">
            <div class="page-container">
                <!-- Home Screen -->
                <div class="page home-screen" :class="{ active: $store.app.currentPage === 'home' }">
                    <div class="clock">
                        <div class="clock-time" x-text="currentTime"></div>
                        <div class="clock-date" x-text="currentDate"></div>
                    </div>
                    
                    <div class="app-grid">
                        <div class="app-icon" @click="navigateTo('chat-list')">
                            <div class="app-icon-image">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="app-icon-label">ËÅäÂ§©</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('world-book')">
                            <div class="app-icon-image">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="app-icon-label">‰∏ñÁïå‰π¶</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('presets')">
                            <div class="app-icon-image">
                                <i class="fas fa-cog"></i>
                            </div>
                            <div class="app-icon-label">È¢ÑËÆæ</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('api-settings')">
                            <div class="app-icon-image">
                                <i class="fas fa-key"></i>
                            </div>
                            <div class="app-icon-label">APIËÆæÁΩÆ</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('moments')" data-testid="moments-icon">
                            <div class="app-icon-image">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="app-icon-label">ÊúãÂèãÂúà</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('settings')">
                            <div class="app-icon-image">
                                <i class="fas fa-palette"></i>
                            </div>
                            <div class="app-icon-label">‰∏ªÈ¢ò</div>
                        </div>
                    </div>
                </div>

                <!-- Chat List Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'chat-list' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">ËÅäÂ§©</div>
                        <div class="header-actions">
                            <button class="header-button" @click="createNewChat()" title="ÂçïËÅä">
                                <i class="fas fa-user"></i>
                            </button>
                            <button class="header-button" @click="createNewGroupChat()" title="Áæ§ËÅä">
                                <i class="fas fa-users"></i>
                            </button>
                        </div>
                    </div>
                    <div class="content">
                        <div class="list-container" x-show="$store.chat.chats.length > 0">
                            <template x-for="chat in $store.chat.chats" :key="chat.id">
                                <div class="list-item" @click="openChat(chat.id)">
                                    <img :src="chat.avatar || 'https://via.placeholder.com/40'" class="list-item-avatar">
                                    <div class="list-item-content">
                                        <div class="list-item-title" x-text="chat.name"></div>
                                        <div class="list-item-subtitle" x-text="chat.lastMessage || 'ÊöÇÊó†Ê∂àÊÅØ'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="$store.chat.chats.length === 0" class="text-center p-4">
                            <p class="text-secondary">ÊöÇÊó†ËÅäÂ§©ËÆ∞ÂΩï</p>
                            <div class="button-group mt-4">
                                <button class="button" @click="createNewChat()">ÂàõÂª∫ÂçïËÅä</button>
                                <button class="button" @click="createNewGroupChat()">ÂàõÂª∫Áæ§ËÅä</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Interface Page -->
                <div class="page chat-page" :class="{ active: $store.app.currentPage === 'chat' }" x-data="chatInterface()">
                    <div class="header">
                        <button class="header-button" @click="$store.app.navigateTo('chat-list')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title" x-text="currentChat?.name || 'ËÅäÂ§©'"></div>
                        <div style="width: 32px;"></div>
                    </div>
                    
                    <!-- Messages Container -->
                    <div class="chat-messages" x-ref="messagesContainer">
                        <template x-for="message in messages" :key="message.id">
                            <div class="message" :class="{ 'user': message.role === 'user', 'assistant': message.role === 'assistant' }">
                                <div class="avatar">
                                    <span x-show="message.role === 'user'" class="user-avatar">üë§</span>
                                    <span x-show="message.role === 'assistant'" class="ai-avatar">ü§ñ</span>
                                </div>
                                <div class="message-content">
                                    <div class="message-text" x-text="message.senderName ? (message.senderName + ': ' + message.content) : (message.content || 'Ê∂àÊÅØÂÜÖÂÆπ‰∏∫Á©∫')"></div>
                                    <div class="message-time" x-text="formatTime(message.timestamp)"></div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Loading indicator -->
                        <div x-show="$store.app.isLoading" class="message assistant">
                            <div class="avatar">
                                <span class="ai-avatar">ü§ñ</span>
                            </div>
                            <div class="message-content">
                                <div class="message-text">AIÊ≠£Âú®ÊÄùËÄÉ‰∏≠...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="chat-input">
                        <div class="input-container">
                            <input 
                                type="text" 
                                x-model="newMessage" 
                                @keydown.enter="sendMessage()"
                                placeholder="ËæìÂÖ•Ê∂àÊÅØ..."
                                class="message-input"
                            >
                            <button @click="sendMessage()" class="send-button" :disabled="!newMessage.trim()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <button @click="triggerAIResponse()" class="ai-button" :disabled="!hasUserMessages()">
                                ü§ñ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- API Settings Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'api-settings' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">APIËÆæÁΩÆ</div>
                        <div style="width: 32px;"></div>
                    </div>
                    <div class="content">
                        <div class="form-group">
                            <label class="form-label">APIÁ±ªÂûã</label>
                            <select class="form-input" x-model="$store.settings.apiConfig.apiType">
                                <option value="openai">OpenAI</option>
                                <option value="gemini">Google Gemini</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">APIÂú∞ÂùÄ</label>
                            <input type="text" class="form-input" x-model="$store.settings.apiConfig.baseURL" 
                                :placeholder="$store.settings.apiConfig.apiType === 'gemini' ? 'Ëá™Âä®‰ΩøÁî® Google ÂÆòÊñπ API' : 'https://api.openai.com'"
                                :disabled="$store.settings.apiConfig.apiType === 'gemini'">
                        </div>
                        <div class="form-group">
                            <label class="form-label">APIÂØÜÈí•</label>
                            <input type="password" class="form-input" x-model="$store.settings.apiConfig.apiKey" 
                                :placeholder="$store.settings.apiConfig.apiType === 'gemini' ? 'AIza...' : 'sk-...'">
                            <small class="form-help">ÊîØÊåÅÂ§ö‰∏™ÂØÜÈí•ÔºåÁî®ÈÄóÂè∑ÂàÜÈöî</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ê®°Âûã</label>
                            <input type="text" class="form-input" x-model="$store.settings.apiConfig.model" 
                                :placeholder="$store.settings.apiConfig.apiType === 'gemini' ? 'gemini-1.5-flash' : 'gpt-3.5-turbo'">
                        </div>
                        <button class="button" @click="saveApiConfig()">‰øùÂ≠òËÆæÁΩÆ</button>
                    </div>
                </div>

                <!-- World Book Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'world-book' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">‰∏ñÁïå‰π¶</div>
                        <button class="header-button" @click="createNewWorldBook()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="content">
                        <div class="list-container" x-show="$store.worldBook.books.length > 0">
                            <template x-for="book in $store.worldBook.books" :key="book.id">
                                <div class="list-item" @click="editWorldBook(book.id)">
                                    <div class="list-item-content">
                                        <div class="list-item-title" x-text="book.name"></div>
                                        <div class="list-item-subtitle" x-text="book.content.substring(0, 50) + '...' || 'ÊöÇÊó†ÂÜÖÂÆπ'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="$store.worldBook.books.length === 0" class="text-center p-4">
                            <p class="text-secondary">ÊöÇÊó†‰∏ñÁïå‰π¶</p>
                            <button class="button mt-4" @click="createNewWorldBook()">ÂàõÂª∫‰∏ñÁïå‰π¶</button>
                        </div>
                    </div>
                </div>

                <!-- Presets Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'presets' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">È¢ÑËÆæÁÆ°ÁêÜ</div>
                        <button class="header-button" @click="createNewPreset()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="content">
                        <div class="list-container" x-show="$store.presets.presets.length > 0">
                            <template x-for="preset in $store.presets.presets" :key="preset.id">
                                <div class="list-item" @click="editPreset(preset.id)">
                                    <div class="list-item-content">
                                        <div class="list-item-title" x-text="preset.name"></div>
                                        <div class="list-item-subtitle" x-text="preset.content.substring(0, 50) + '...' || 'ÊöÇÊó†ÂÜÖÂÆπ'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="$store.presets.presets.length === 0" class="text-center p-4">
                            <p class="text-secondary">ÊöÇÊó†È¢ÑËÆæ</p>
                            <button class="button mt-4" @click="createNewPreset()">ÂàõÂª∫È¢ÑËÆæ</button>
                        </div>
                    </div>
                </div>

                <!-- Moments Page -->
                <div class="page moments-page" :class="{ active: $store.app.currentPage === 'moments' }" x-data="momentsInterface()">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">ÊúãÂèãÂúà</div>
                        <button class="header-button" @click="showCreateMoment()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    
                    <!-- Moments Feed -->
                    <div class="moments-feed" x-ref="momentsContainer">
                        <template x-for="moment in $store.moments.moments" :key="moment.id">
                            <div class="moment-item">
                                <!-- User Info -->
                                <div class="moment-header">
                                    <div class="moment-avatar" x-text="moment.userAvatar"></div>
                                    <div class="moment-user-info">
                                        <div class="moment-username" x-text="moment.userName"></div>
                                        <div class="moment-time" x-text="$store.moments.formatTime(moment.timestamp)"></div>
                                        <div x-show="moment.location" class="moment-location" x-text="moment.location"></div>
                                    </div>
                                </div>
                                
                                <!-- Content -->
                                <div class="moment-content">
                                    <div x-show="moment.content" class="moment-text" x-text="moment.content"></div>
                                    
                                    <!-- Images Grid -->
                                    <div x-show="moment.images && moment.images.length > 0" class="moment-images" :class="'images-' + moment.images.length">
                                        <template x-for="(image, index) in moment.images" :key="index">
                                            <div class="moment-image">
                                                <img :src="image" :alt="'ÂõæÁâá' + (index + 1)" @click="showImage(image)">
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <div class="moment-actions">
                                    <button class="action-button" @click="$store.moments.toggleLike(moment.id)" 
                                            :class="{ liked: $store.moments.isLikedByUser(moment.id) }">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                    <button class="action-button" @click="showCommentInput(moment.id)">
                                        <i class="fas fa-comment"></i>
                                    </button>
                                </div>
                                
                                <!-- Likes and Comments Info -->
                                <div class="moment-stats">
                                    <div x-show="$store.moments.getMomentsLikes(moment.id).length > 0" class="likes-info">
                                        <i class="fas fa-heart"></i>
                                        <span x-text="$store.moments.getMomentsLikes(moment.id).map(l => l.userName).join(', ')"></span>
                                    </div>
                                </div>
                                
                                <!-- Comments -->
                                <div x-show="$store.moments.getMomentsComments(moment.id).length > 0" class="moment-comments">
                                    <template x-for="comment in $store.moments.getMomentsComments(moment.id)" :key="comment.id">
                                        <div class="comment-item">
                                            <span class="comment-user" x-text="comment.userName"></span>
                                            <span x-show="comment.replyTo" class="comment-reply">ÂõûÂ§ç<span x-text="comment.replyTo"></span></span>
                                            <span class="comment-content" x-text="comment.content"></span>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Comment Input -->
                                <div x-show="activeCommentInput === moment.id" class="comment-input-container">
                                    <input type="text" x-model="commentText" 
                                           :placeholder="'ËØÑËÆ∫' + moment.userName + '...'"
                                           @keydown.enter="submitComment(moment.id)"
                                           class="comment-input">
                                    <button @click="submitComment(moment.id)" class="comment-submit">ÂèëÈÄÅ</button>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Empty State -->
                        <div x-show="$store.moments.moments.length === 0" class="empty-state">
                            <i class="fas fa-heart-broken"></i>
                            <p>ËøòÊ≤°ÊúâÊúãÂèãÂúàÂä®ÊÄÅ</p>
                            <button class="button" @click="showCreateMoment()">ÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°ÊúãÂèãÂúà</button>
                        </div>
                    </div>
                    
                    <!-- Create Moment Modal -->
                    <div x-show="$store.moments.showCreateModal" class="modal-overlay" @click="hideCreateMoment()">
                        <div class="modal" @click.stop>
                            <div class="modal-header">
                                <button @click="hideCreateMoment()">ÂèñÊ∂à</button>
                                <span>ÂèëÊúãÂèãÂúà</span>
                                <button @click="publishMoment()" :disabled="!newMomentContent.trim()">ÂèëË°®</button>
                            </div>
                            <div class="modal-content">
                                <textarea x-model="newMomentContent" 
                                         placeholder="Ëøô‰∏ÄÂàªÁöÑÊÉ≥Ê≥ï..." 
                                         class="moment-textarea"
                                         rows="6"></textarea>
                                
                                <!-- Image URL Input (ÁÆÄÂåñÂÆûÁé∞) -->
                                <div class="image-input-section">
                                    <label>Ê∑ªÂä†ÂõæÁâá (ÂèØÈÄâ)</label>
                                    <div>
                                        <input type="url" x-model="newImageUrl" 
                                               placeholder="ËæìÂÖ•ÂõæÁâáURL..." 
                                               class="image-url-input">
                                        <button @click="addImage()" :disabled="!newImageUrl.trim()">Ê∑ªÂä†</button>
                                    </div>
                                </div>
                                
                                <!-- Preview Images -->
                                <div x-show="newMomentImages.length > 0" class="preview-images">
                                    <template x-for="(image, index) in newMomentImages" :key="index">
                                        <div class="preview-image">
                                            <img :src="image" :alt="'È¢ÑËßà' + (index + 1)">
                                            <button @click="removeImage(index)" class="remove-image">√ó</button>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Location Input -->
                                <div class="location-input-section">
                                    <input type="text" x-model="newMomentLocation" 
                                           placeholder="ÊâÄÂú®‰ΩçÁΩÆ (ÂèØÈÄâ)..." 
                                           class="location-input">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js?v=1.0.4"></script>
</body>
</html>