<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>RuaPhone</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css?v=1.3.0">
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
</head>
<body>
    <div class="phone-frame" x-data="phoneApp()" x-init="init()">
        <!-- Status Bar -->
        <div class="status-bar">
            <div x-text="currentTime"></div>
            <div class="battery">
                <span x-text="batteryLevel + '%'"></span>
                <div class="battery-icon">
                    <div class="battery-level" :style="`width: ${batteryLevel}%`"></div>
                </div>
            </div>
        </div>

        <!-- Screen Content -->
        <div class="screen">
            <div class="page-container">
                <!-- Home Screen -->
                <div class="page home-screen" :class="{ active: $store.app.currentPage === 'home' }">
                    <div class="clock">
                        <div class="clock-time" x-text="currentTime"></div>
                        <div class="clock-date" x-text="currentDate"></div>
                    </div>
                    
                    <div class="app-grid">
                        <div class="app-icon" @click="navigateTo('chat-list')">
                            <div class="app-icon-image">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="app-icon-label">ËÅäÂ§©</div>
                        </div>

                        <div class="app-icon" @click="navigateTo('moments')" data-testid="moments-icon">
                            <div class="app-icon-image">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="app-icon-label">ÊúãÂèãÂúà</div>
                        </div>

                        <!-- <div class="app-icon" @click="navigateTo('settings')">
                            <div class="app-icon-image">
                                <i class="fas fa-palette"></i>
                            </div>
                            <div class="app-icon-label">‰∏ªÈ¢ò</div>
                        </div> -->
                        
                        <!-- <div class="app-icon" @click="navigateTo('world-book')">
                            <div class="app-icon-image">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="app-icon-label">‰∏ñÁïå‰π¶</div>
                        </div> -->
                        
                        <div class="app-icon" @click="navigateTo('personas')">
                            <div class="app-icon-image">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <div class="app-icon-label">ÈÄöËÆØÂΩï</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('profile')">
                            <div class="app-icon-image">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="app-icon-label">‰∏™‰∫∫ËµÑÊñô</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('api-settings')">
                            <div class="app-icon-image">
                                <i class="fas fa-key"></i>
                            </div>
                            <div class="app-icon-label">APIËÆæÁΩÆ</div>
                        </div>
                        
                        
                    </div>
                    
                    <!-- Version info -->
                    <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: #999; font-size: 10px; text-align: center;">
                        RuaPhone v1.3.0
                    </div>
                </div>

                <!-- Chat List Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'chat-list' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">ËÅäÂ§©</div>
                        <div class="header-actions">
                            <button class="header-button" @click="$dispatch('open-create-chat')" title="ÁßÅËÅä">
                                <i class="fas fa-user"></i>
                            </button>
                            <button class="header-button" @click="createNewGroupChat()" title="Áæ§ËÅä">
                                <i class="fas fa-users"></i>
                            </button>
                        </div>
                    </div>
                    <div class="content">
                        <div class="list-container" x-show="$store.chat.chats.length > 0">
                            <template x-for="chat in $store.chat.chats" :key="chat.id">
                                <div class="list-item" @click="openChat(chat.id)">
                                    <div class="list-item-avatar-container">
                                        <img x-show="chat.avatar && chat.avatar !== 'https://via.placeholder.com/40'" 
                                             :src="chat.avatar" 
                                             :alt="chat.name"
                                             class="list-item-avatar"
                                             @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='flex';">
                                        <div x-show="!chat.avatar || chat.avatar === 'https://via.placeholder.com/40'" class="list-item-avatar-fallback">ü§ñ</div>
                                    </div>
                                    <div class="list-item-content">
                                        <div class="list-item-title" x-text="chat.name"></div>
                                        <div class="list-item-subtitle" x-text="chat.lastMessage || 'ÊöÇÊó†Ê∂àÊÅØ'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="$store.chat.chats.length === 0" class="text-center p-4">
                            <p class="text-secondary">ÊöÇÊó†ËÅäÂ§©ËÆ∞ÂΩï</p>
                            <div class="button-group mt-4">
                                <button class="button" @click="$dispatch('open-create-chat')">ÂàõÂª∫ÁßÅËÅä</button>
                                <button class="button" @click="createNewGroupChat()">ÂàõÂª∫Áæ§ËÅä</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Interface Page -->
                <div class="page chat-page" :class="{ active: $store.app.currentPage === 'chat' }" x-data="chatInterface()">
                    <div class="header">
                        <button class="header-button" @click="$store.app.navigateTo('chat-list')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-center">
                            <div class="chat-header-avatar">
                                <img x-show="currentChat?.avatar && currentChat.avatar !== 'https://via.placeholder.com/40'" 
                                     :src="currentChat?.avatar" 
                                     :alt="currentChat?.name"
                                     @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='inline';">
                                <span x-show="!currentChat?.avatar || currentChat.avatar === 'https://via.placeholder.com/40'" class="fallback-avatar">ü§ñ</span>
                            </div>
                            <div class="header-title" x-text="currentChat?.name || 'ËÅäÂ§©'"></div>
                        </div>
                        <div style="width: 32px;"></div>
                    </div>
                    
                    <!-- Messages Container -->
                    <div class="chat-messages" x-ref="messagesContainer">
                        <template x-for="message in messages" :key="message.id">
                            <div class="message" :class="{ 'user': message.role === 'user', 'assistant': message.role === 'assistant' }">
                                <div class="avatar">
                                    <div x-show="message.role === 'user'" class="user-avatar">
                                        <img x-show="$store.profile.profile.avatar" 
                                             :src="$store.profile.profile.avatar" 
                                             alt="ÊàëÁöÑÂ§¥ÂÉè"
                                             class="user-avatar-img"
                                             @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='inline';">
                                        <span x-show="!$store.profile.profile.avatar">üë§</span>
                                    </div>
                                    <div x-show="message.role === 'assistant'" class="ai-avatar">
                                        <img x-show="currentChat?.avatar && currentChat.avatar !== 'https://via.placeholder.com/40'" 
                                             :src="currentChat?.avatar" 
                                             :alt="currentChat?.name"
                                             @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='inline';">
                                        <span x-show="!currentChat?.avatar || currentChat.avatar === 'https://via.placeholder.com/40'">ü§ñ</span>
                                    </div>
                                </div>
                                <div class="message-content">
                                    <div class="message-text" x-text="message.senderName ? (message.senderName + ': ' + message.content) : (message.content || 'Ê∂àÊÅØÂÜÖÂÆπ‰∏∫Á©∫')"></div>
                                    <div class="message-time" x-text="formatTime(message.timestamp)"></div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Loading indicator -->
                        <div x-show="$store.app.isLoading" class="message assistant">
                            <div class="avatar">
                                <div class="ai-avatar">
                                    <img x-show="currentChat?.avatar && currentChat.avatar !== 'https://via.placeholder.com/40'" 
                                         :src="currentChat?.avatar" 
                                         :alt="currentChat?.name"
                                         @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='inline';">
                                    <span x-show="!currentChat?.avatar || currentChat.avatar === 'https://via.placeholder.com/40'">ü§ñ</span>
                                </div>
                            </div>
                            <div class="message-content">
                                <div class="message-text">AIÊ≠£Âú®ÊÄùËÄÉ‰∏≠...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="chat-input">
                        <div class="input-container">
                            <input 
                                type="text" 
                                x-model="newMessage" 
                                @keydown.enter="sendMessage()"
                                placeholder="ËæìÂÖ•Ê∂àÊÅØ..."
                                class="message-input"
                            >
                            <div class="button-group">
                                <button @click="triggerAIResponse()" class="ai-button" :disabled="!hasUserMessages()">
                                    üì≥
                                </button>
                                <button @click="sendMessage()" class="send-button" :disabled="!newMessage.trim()">
                                    ÂèëÈÄÅ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'profile' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">‰∏™‰∫∫ËµÑÊñô</div>
                        <button class="header-button profile-save-btn" @click="saveProfile()" :disabled="profileSaving">
                            <template x-if="!profileSaving">
                                <span>‰øùÂ≠ò</span>
                            </template>
                            <template x-if="profileSaving">
                                <i class="fas fa-spinner fa-spin"></i>
                            </template>
                        </button>
                    </div>
                    <div class="content profile-content">
                        <!-- Avatar Section -->
                        <div class="profile-avatar-section">
                            <div class="profile-avatar-container" @click="$refs.avatarInput.click()">
                                <img x-show="$store.profile.profile.avatar" 
                                     :src="$store.profile.profile.avatar" 
                                     alt="Â§¥ÂÉè"
                                     class="profile-avatar">
                                <div x-show="!$store.profile.profile.avatar" class="profile-avatar-placeholder">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="profile-avatar-overlay">
                                    <i class="fas fa-camera"></i>
                                </div>
                            </div>
                            <input type="file" 
                                   x-ref="avatarInput" 
                                   @change="handleAvatarUpload($event)" 
                                   accept="image/*" 
                                   style="display: none;">
                        </div>
                        
                        <!-- Profile Form -->
                        <div class="profile-form">
                            <div class="form-group">
                                <label class="form-label">ÂßìÂêç</label>
                                <input type="text" 
                                       class="form-input" 
                                       x-model="$store.profile.profile.name" 
                                       placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂßìÂêç">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÊÄßÂà´</label>
                                <input type="text" 
                                       class="form-input" 
                                       x-model="$store.profile.profile.gender" 
                                       placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊÄßÂà´">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Âπ¥ÈæÑ</label>
                                <input type="number" 
                                       class="form-input" 
                                       x-model="$store.profile.profile.age" 
                                       placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂπ¥ÈæÑ"
                                       min="1" 
                                       max="150">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">‰∏™‰∫∫‰ªãÁªç</label>
                                <textarea class="form-input profile-bio" 
                                          x-model="$store.profile.profile.bio" 
                                          placeholder="‰ªãÁªç‰∏Ä‰∏ãËá™Â∑±Âêß..."
                                          rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Settings Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'api-settings' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">APIËÆæÁΩÆ</div>
                        <div style="width: 32px;"></div>
                    </div>
                    <div class="content">
                        <!-- Version Display -->
                        <div class="version-info" style="
                            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
                            color: white;
                            padding: 12px 16px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            text-align: center;
                            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
                        ">
                            <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">
                                üöÄ RuaPhone v1.3.0
                            </div>
                            <div style="font-size: 12px; opacity: 0.9;">
                                ÂèØÁà±ÁöÑÂ∞èÊâãÊú∫rua~
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">APIÁ±ªÂûã</label>
                            <select class="form-input" x-model="$store.settings.apiConfig.apiType" 
                                @change="$store.settings.updateApiType($event.target.value)">
                                <option value="openai">OpenAI</option>
                                <option value="gemini">Google Gemini</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">APIÂú∞ÂùÄ</label>
                            <input type="text" class="form-input" x-model="$store.settings.apiConfig.baseURL" 
                                :placeholder="$store.settings.apiConfig.apiType === 'gemini' ? 'Ëá™Âä®‰ΩøÁî® Google ÂÆòÊñπ API' : 'https://api.openai.com'"
                                :disabled="$store.settings.apiConfig.apiType === 'gemini'">
                            <small class="form-help" x-show="$store.settings.apiConfig.apiType !== 'gemini'">
                                ÁªìÂ∞æÊúâÊ≤°Êúâ/v1ÈÉΩÂèØ‰ª•
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">APIÂØÜÈí•</label>
                            <input type="password" class="form-input" x-model="$store.settings.apiConfig.apiKey" 
                                :placeholder="$store.settings.apiConfig.apiType === 'gemini' ? 'AIza...' : 'sk-...'">
                            <small class="form-help">ÊîØÊåÅÂ§ö‰∏™ÂØÜÈí•ÔºåÁî®ÈÄóÂè∑ÂàÜÈöî</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ê®°Âûã</label>
                            
                            <!-- Gemini Models -->
                            <template x-if="$store.settings.apiConfig.apiType === 'gemini'">
                                <select class="form-input" x-model="$store.settings.apiConfig.model">
                                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (ÂÆûÈ™åÁâà)</option>
                                    <option value="gemini-exp-1206">Gemini Experimental 1206</option>
                                </select>
                            </template>
                            
                            <!-- OpenAI-compatible Models -->
                            <template x-if="$store.settings.apiConfig.apiType !== 'gemini'">
                                <div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select class="form-input" x-model="$store.settings.apiConfig.model" style="flex: 1;">
                                            <option value="" disabled>
                                                <span x-show="$store.settings.modelsLoading">Ê≠£Âú®Âä†ËΩΩÊ®°Âûã...</span>
                                                <span x-show="!$store.settings.modelsLoading && $store.settings.availableModels.length === 0">ËØ∑ÂÖàÈÖçÁΩÆAPIÂú∞ÂùÄÂíåÂØÜÈí•</span>
                                            </option>
                                            <template x-for="model in $store.settings.availableModels" :key="model.id">
                                                <option :value="model.id" x-text="model.id"></option>
                                            </template>
                                        </select>
                                        <button type="button" 
                                            class="button" 
                                            style="padding: 8px 12px; font-size: 14px; background: #007AFF;" 
                                            @click="$store.settings.refreshModels()"
                                            :disabled="$store.settings.modelsLoading"
                                            :class="{ 'opacity-50 cursor-not-allowed': $store.settings.modelsLoading }">
                                            ÊãâÂèñ
                                        </button>
                                    </div>
                                    
                                    <!-- Loading indicator -->
                                    <div x-show="$store.settings.modelsLoading" 
                                        class="form-help" 
                                        style="color: #007AFF; margin-top: 8px;">
                                        <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                                        Ê≠£Âú®‰ªé API Ëé∑ÂèñÊ®°ÂûãÂàóË°®...
                                    </div>
                                    
                                    <!-- Error message -->
                                    <div x-show="$store.settings.modelsError" 
                                        class="form-help" 
                                        style="color: #FF3B30; margin-top: 8px;">
                                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                                        <span x-text="$store.settings.modelsError"></span>
                                    </div>
                                    
                                    <!-- Success message -->
                                    <div x-show="!$store.settings.modelsError && !$store.settings.modelsLoading && $store.settings.availableModels.length > 0" 
                                        class="form-help" 
                                        style="color: #34C759; margin-top: 8px;">
                                        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                                        Â∑≤Âä†ËΩΩ <span x-text="$store.settings.availableModels.length"></span> ‰∏™Ê®°Âûã
                                        <span x-show="$store.settings.modelsLastFetch">
                                            (ÁºìÂ≠ò 5 ÂàÜÈíü)
                                        </span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <template x-if="$store.settings.apiConfig.apiType === 'gemini'">
                            <div class="form-group">
                                <div class="form-help" style="background: #e8f4fd; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                    <p style="margin: 0 0 8px 0; font-weight: 500;">üìã ‰ΩøÁî®ËØ¥ÊòéÔºö</p>
                                    <p style="margin: 0 0 4px 0;">1. ËÆøÈóÆ <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #1976d2;">Google AI Studio</a> Ëé∑ÂèñÂÖçË¥πAPIÂØÜÈí•</p>
                                    <p style="margin: 0 0 4px 0;">2. APIÂØÜÈí•Ê†ºÂºèÔºöAIzaÂºÄÂ§¥ÁöÑÂ≠óÁ¨¶‰∏≤</p>
                                    <p style="margin: 0;">3. Êé®Ëçê‰ΩøÁî®Gemini 1.5 FlashÔºàÈÄüÂ∫¶Âø´ÔºåÂÖçË¥πÈ¢ùÂ∫¶È´òÔºâ</p>
                                </div>
                            </div>
                        </template>
                        <button class="button" @click="saveApiConfig()">‰øùÂ≠òËÆæÁΩÆ</button>
                        
                        <!-- Data Management Section -->
                        <div class="form-section" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #E5E5EA;">
                            <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1C1C1E;">Êï∞ÊçÆÁÆ°ÁêÜ</h3>
                            
                            <div class="form-group">
                                <div class="form-help" style="background: #F2F2F7; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                    <p style="margin: 0 0 8px 0; font-weight: 500; color: #1C1C1E;">
                                        <span x-text="$store.app.storageStatus === 'persistent' ? 'üîí Êï∞ÊçÆÂ∑≤ÊåÅ‰πÖÂåñ' : 
                                                     $store.app.storageStatus === 'not-persistent' ? '‚ö†Ô∏è ‰∏¥Êó∂Â≠òÂÇ®Ê®°Âºè' : 
                                                     $store.app.storageStatus === 'not-supported' ? '‚ùå ‰∏çÊîØÊåÅÊåÅ‰πÖÂ≠òÂÇ®' : 'üîÑ Ê£ÄÊü•‰∏≠...'"></span>
                                    </p>
                                    <p style="margin: 0; font-size: 14px; color: #8E8E93;">
                                        <span x-show="$store.app.storageStatus === 'persistent'">ÊÇ®ÁöÑÊï∞ÊçÆÂ∑≤Ëé∑ÂæóÊåÅ‰πÖÂåñ‰øùÊä§Ôºå‰∏ç‰ºöË¢´Ëá™Âä®Ê∏ÖÁêÜ„ÄÇ</span>
                                        <span x-show="$store.app.storageStatus === 'not-persistent'">Âª∫ËÆÆÁî≥ËØ∑ÊåÅ‰πÖÂåñÊùÉÈôêÂπ∂ÂÆöÊúüÂ§á‰ªΩÊï∞ÊçÆ„ÄÇ</span>
                                        <span x-show="$store.app.storageStatus === 'not-supported'">ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÊåÅ‰πÖÂåñÂ≠òÂÇ®ÔºåËØ∑ÂÆöÊúüÂ§á‰ªΩÊï∞ÊçÆ„ÄÇ</span>
                                    </p>
                                </div>
                            </div>
                            
                            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <button class="button" style="background: #34C759;" @click="window.exportData && window.exportData()">
                                    <i class="fas fa-download" style="margin-right: 8px;"></i>
                                    ÂØºÂá∫Êï∞ÊçÆ
                                </button>
                                <button class="button" style="background: #FF9500;" @click="window.importData && window.importData()">
                                    <i class="fas fa-upload" style="margin-right: 8px;"></i>
                                    ÂØºÂÖ•Êï∞ÊçÆ
                                </button>
                            </div>
                            
                            <div class="form-group" x-show="$store.app.storageStatus !== 'persistent'">
                                <button class="button" style="background: #007AFF;" @click="$store.app.requestPersistentStorage().then(granted => {
                                    if (granted) {
                                        alert('‚úÖ Â∑≤Ëé∑ÂæóÊåÅ‰πÖÂåñÂ≠òÂÇ®ÊùÉÈôêÔºÅ');
                                    } else {
                                        alert('‚ö†Ô∏è Êú™ËÉΩËé∑ÂæóÊåÅ‰πÖÂåñÂ≠òÂÇ®ÊùÉÈôê„ÄÇÊÇ®ÁöÑÊï∞ÊçÆ‰ªçÂèØÊ≠£Â∏∏‰ΩøÁî®Ôºå‰ΩÜÂª∫ËÆÆÂÆöÊúüÂ§á‰ªΩ„ÄÇ');
                                    }
                                })">
                                    <i class="fas fa-shield-alt" style="margin-right: 8px;"></i>
                                    Áî≥ËØ∑Êï∞ÊçÆÊåÅ‰πÖÂåñ
                                </button>
                            </div>
                            
                            <template x-if="location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.port">
                                <div class="form-group" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E5E5EA;">
                                    <button class="button" style="background: #FF3B30;" @click="window.resetDatabase && window.resetDatabase()">
                                        <i class="fas fa-trash" style="margin-right: 8px;"></i>
                                        ÈáçÁΩÆÊï∞ÊçÆÂ∫ì (ÂºÄÂèëÊ®°Âºè)
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- World Book Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'world-book' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">‰∏ñÁïå‰π¶</div>
                        <button class="header-button" @click="createNewWorldBook()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="content">
                        <div class="list-container" x-show="$store.worldBook.books.length > 0">
                            <template x-for="book in $store.worldBook.books" :key="book.id">
                                <div class="list-item" @click="editWorldBook(book.id)">
                                    <div class="list-item-content">
                                        <div class="list-item-title" x-text="book.name"></div>
                                        <div class="list-item-subtitle" x-text="book.content.substring(0, 50) + '...' || 'ÊöÇÊó†ÂÜÖÂÆπ'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="$store.worldBook.books.length === 0" class="text-center p-4">
                            <p class="text-secondary">ÊöÇÊó†‰∏ñÁïå‰π¶</p>
                            <button class="button mt-4" @click="createNewWorldBook()">ÂàõÂª∫‰∏ñÁïå‰π¶</button>
                        </div>
                    </div>
                </div>


                <!-- Personas Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'personas' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">ÈÄöËÆØÂΩï</div>
                        <button class="header-button" @click="$dispatch('open-create-persona')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div class="content">
                        <div class="personas-list">
                            <template x-for="persona in $store.personas.personas" :key="persona.id">
                                <div class="persona-item">
                                    <div class="persona-avatar">
                                        <img :src="persona.avatar" :alt="persona.name" />
                                    </div>
                                    <div class="persona-info">
                                        <div class="persona-name" x-text="persona.name"></div>
                                        <div class="persona-preview" x-text="persona.persona.slice(0, 50) + (persona.persona.length > 50 ? '...' : '')"></div>
                                    </div>
                                    <div class="persona-actions">
                                        <button class="edit-button" @click="$dispatch('edit-persona', persona)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="delete-button" @click="
                                            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∫∫ËÆæÂêóÔºü')) {
                                                $store.personas.deletePersona(persona.id);
                                            }
                                        ">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                            
                            <div x-show="$store.personas.personas.length === 0" class="empty-state">
                                <i class="fas fa-user-friends empty-icon"></i>
                                <div class="empty-title">ÊöÇÊó†‰∫∫ËÆæ</div>
                                <div class="empty-subtitle">ÁÇπÂáªÂè≥‰∏äËßí + ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™‰∫∫ËÆæ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Moments Page -->
                <div class="page moments-page" :class="{ active: $store.app.currentPage === 'moments' }" x-data="momentsInterface()">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">ÊúãÂèãÂúà</div>
                        <button class="header-button" @click="showCreateMoment()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    
                    <!-- Moments Feed -->
                    <div class="moments-feed" x-ref="momentsContainer">
                        <template x-for="moment in $store.moments.moments" :key="moment.id">
                            <div class="moment-item">
                                <!-- User Info -->
                                <div class="moment-header">
                                    <div class="moment-avatar" x-text="moment.userAvatar"></div>
                                    <div class="moment-user-info">
                                        <div class="moment-username" x-text="moment.userName"></div>
                                        <div class="moment-time" x-text="$store.moments.formatTime(moment.timestamp)"></div>
                                        <div x-show="moment.location" class="moment-location" x-text="moment.location"></div>
                                    </div>
                                </div>
                                
                                <!-- Content -->
                                <div class="moment-content">
                                    <div x-show="moment.content" class="moment-text" x-text="moment.content"></div>
                                    
                                    <!-- Images Grid -->
                                    <div x-show="moment.images && moment.images.length > 0" class="moment-images" :class="'images-' + moment.images.length">
                                        <template x-for="(image, index) in moment.images" :key="index">
                                            <div class="moment-image">
                                                <img :src="image" :alt="'ÂõæÁâá' + (index + 1)" @click="showImage(image)">
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <div class="moment-actions">
                                    <button class="action-button" @click="$store.moments.toggleLike(moment.id)" 
                                            :class="{ liked: $store.moments.isLikedByUser(moment.id) }">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                    <button class="action-button" @click="showCommentInput(moment.id)">
                                        <i class="fas fa-comment"></i>
                                    </button>
                                </div>
                                
                                <!-- Likes and Comments Info -->
                                <div class="moment-stats">
                                    <div x-show="$store.moments.getMomentsLikes(moment.id).length > 0" class="likes-info">
                                        <i class="fas fa-heart"></i>
                                        <span x-text="$store.moments.getMomentsLikes(moment.id).map(l => l.userName).join(', ')"></span>
                                    </div>
                                </div>
                                
                                <!-- Comments -->
                                <div x-show="$store.moments.getMomentsComments(moment.id).length > 0" class="moment-comments">
                                    <template x-for="comment in $store.moments.getMomentsComments(moment.id)" :key="comment.id">
                                        <div class="comment-item">
                                            <span class="comment-user" x-text="comment.userName"></span>
                                            <span x-show="comment.replyTo" class="comment-reply">ÂõûÂ§ç<span x-text="comment.replyTo"></span></span>
                                            <span class="comment-content" x-text="comment.content"></span>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Comment Input -->
                                <div x-show="activeCommentInput === moment.id" class="comment-input-container">
                                    <input type="text" x-model="commentText" 
                                           :placeholder="'ËØÑËÆ∫' + moment.userName + '...'"
                                           @keydown.enter="submitComment(moment.id)"
                                           class="comment-input">
                                    <button @click="submitComment(moment.id)" class="comment-submit">ÂèëÈÄÅ</button>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Empty State -->
                        <div x-show="$store.moments.moments.length === 0" class="empty-state">
                            <i class="fas fa-heart-broken"></i>
                            <p>ËøòÊ≤°ÊúâÊúãÂèãÂúàÂä®ÊÄÅ</p>
                            <button class="button" @click="showCreateMoment()">ÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°ÊúãÂèãÂúà</button>
                        </div>
                    </div>
                    
                    <!-- Create Moment Modal -->
                    <div x-show="$store.moments.showCreateModal" class="modal-overlay" @click="hideCreateMoment()">
                        <div class="modal" @click.stop>
                            <div class="modal-header">
                                <button @click="hideCreateMoment()">ÂèñÊ∂à</button>
                                <span>ÂèëÊúãÂèãÂúà</span>
                                <button @click="publishMoment()" :disabled="!newMomentContent.trim()">ÂèëË°®</button>
                            </div>
                            <div class="modal-content">
                                <textarea x-model="newMomentContent" 
                                         placeholder="Ëøô‰∏ÄÂàªÁöÑÊÉ≥Ê≥ï..." 
                                         class="moment-textarea"
                                         rows="6"></textarea>
                                
                                <!-- Local Image Upload -->
                                <div class="image-input-section">
                                    <label>Ê∑ªÂä†ÂõæÁâá (ÂèØÈÄâ)</label>
                                    <div>
                                        <input type="file" 
                                               accept="image/*" 
                                               @change="handleImageUpload($event)"
                                               class="image-file-input"
                                               style="display: none;"
                                               x-ref="imageInput">
                                        <button @click="$refs.imageInput.click()" class="upload-button">
                                            <i class="fas fa-camera"></i> ÈÄâÊã©ÂõæÁâá
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Preview Images -->
                                <div x-show="newMomentImages.length > 0" class="preview-images">
                                    <template x-for="(image, index) in newMomentImages" :key="index">
                                        <div class="preview-image">
                                            <img :src="image" :alt="'È¢ÑËßà' + (index + 1)">
                                            <button @click="removeImage(index)" class="remove-image">√ó</button>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Location Input -->
                                <div class="location-input-section">
                                    <input type="text" x-model="newMomentLocation" 
                                           placeholder="ÊâÄÂú®‰ΩçÁΩÆ (ÂèØÈÄâ)..." 
                                           class="location-input">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Chat Modal -->
        <div class="modal" :class="{ active: showCreateChatModal }" 
             x-data="{
                 showCreateChatModal: false,
                 selectedPersonaId: '',
                 selectedPersona: null,
                 init() {
                     console.log('Create Chat Modal initialized:', this.showCreateChatModal);
                 }
             }"
             @open-create-chat.window="
                 selectedPersonaId = ''; 
                 selectedPersona = null; 
                 showCreateChatModal = true;
                 console.log('Opening create chat modal');
             ">
            <div class="modal-overlay" @click="showCreateChatModal = false"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ÂàõÂª∫ÁßÅËÅä</h3>
                    <button class="close-button" @click="showCreateChatModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>ÈÄâÊã©‰∫∫ËÆæ</label>
                        <div class="persona-selector">
                            <template x-for="persona in $store.personas.personas" :key="persona.id">
                                <div class="persona-option" 
                                     :class="{ selected: selectedPersonaId === persona.id }"
                                     @click="selectedPersonaId = persona.id; selectedPersona = persona;">
                                    <div class="persona-avatar">
                                        <img :src="persona.avatar" :alt="persona.name" />
                                    </div>
                                    <div class="persona-name" x-text="persona.name"></div>
                                </div>
                            </template>
                        </div>
                        <div x-show="selectedPersona" class="selected-persona-preview">
                            <strong>ÈÄâ‰∏≠ÁöÑ‰∫∫ËÆæÔºö</strong>
                            <p x-text="selectedPersona?.persona"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" @click="showCreateChatModal = false">ÂèñÊ∂à</button>
                    <button class="button primary" @click="
                        if (!selectedPersona) { 
                            alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™‰∫∫ËÆæ'); 
                            return; 
                        }
                        $store.chat.createChat(selectedPersona.name, 'single', selectedPersona.persona, selectedPersona.id, selectedPersona.avatar).then(chatId => {
                            $store.app.navigateTo('chat', { chatId });
                            showCreateChatModal = false;
                        });
                    ">ÂàõÂª∫</button>
                </div>
            </div>
        </div>

        <!-- Persona Edit Modal -->
        <div class="modal" :class="{ active: showPersonaModal }" 
             x-data="{ 
                 showPersonaModal: false, 
                 editingPersonaId: null,
                 personaName: '',
                 personaAvatar: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNFNUU1RUEiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzk5OTk5OSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPgo8cGF0aCBkPSJtMjAgMjEtMTYtMTZtMCAwIDMuNSAzLjVNMTcgMTcuNSA2IDciLz4KPHN2Zz4KPC9zdmc+Cjwvc3ZnPgo=',
                 personaText: '',
                 init() {
                     console.log('Persona Modal initialized:', this.showPersonaModal);
                 },
                 async handleAvatarUpload(event) {
                     const file = event.target.files[0];
                     if (!file) return;
                     
                     try {
                         const base64 = await window.fileToBase64(file);
                         this.personaAvatar = base64;
                         event.target.value = '';
                     } catch (error) {
                         alert(error.message);
                     }
                 }
             }"
             @open-create-persona.window="
                 editingPersonaId = null;
                 personaName = '';
                 personaAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNFNUU1RUEiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzk5OTk5OSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPgo8cGF0aCBkPSJtMjAgMjEtMTYtMTZtMCAwIDMuNSAzLjVNMTcgMTcuNSA2IDciLz4KPHN2Zz4KPC9zdmc+Cjwvc3ZnPgo=';
                 personaText = '';
                 showPersonaModal = true;
             "
             @edit-persona.window="
                 editingPersonaId = $event.detail.id;
                 personaName = $event.detail.name;
                 personaAvatar = $event.detail.avatar;
                 personaText = $event.detail.persona;
                 showPersonaModal = true;
             ">
            <div class="modal-overlay" @click="showPersonaModal = false"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 x-text="editingPersonaId ? 'ÁºñËæë‰∫∫ËÆæ' : 'ÂàõÂª∫‰∫∫ËÆæ'"></h3>
                    <button class="close-button" @click="showPersonaModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>‰∫∫ËÆæÂêçÁß∞</label>
                        <input type="text" x-model="personaName" placeholder="ËØ∑ËæìÂÖ•‰∫∫ËÆæÂêçÁß∞" />
                    </div>
                    <div class="form-group">
                        <label>Â§¥ÂÉè</label>
                        <div class="avatar-upload-section">
                            <div class="avatar-preview">
                                <img :src="personaAvatar" :alt="personaName" class="preview-avatar" />
                            </div>
                            <div class="avatar-upload-controls">
                                <input type="file" 
                                       accept="image/*" 
                                       @change="handleAvatarUpload($event)"
                                       class="avatar-file-input"
                                       style="display: none;"
                                       x-ref="avatarInput">
                                <button @click="$refs.avatarInput.click()" class="upload-button">
                                    <i class="fas fa-camera"></i> ÈÄâÊã©Â§¥ÂÉè
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>‰∫∫ËÆæÊèèËø∞</label>
                        <textarea x-model="personaText" rows="6" placeholder="ËØ∑ËæìÂÖ•ËØ¶ÁªÜÁöÑ‰∫∫ËÆæÊèèËø∞..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" @click="showPersonaModal = false">ÂèñÊ∂à</button>
                    <button class="button primary" @click="
                        if (!personaName.trim()) {
                            alert('ËØ∑ËæìÂÖ•‰∫∫ËÆæÂêçÁß∞');
                            return;
                        }
                        if (editingPersonaId) {
                            $store.personas.updatePersona(editingPersonaId, {
                                name: personaName.trim(),
                                avatar: personaAvatar,
                                persona: personaText.trim()
                            }).then(() => { showPersonaModal = false; });
                        } else {
                            $store.personas.createPersona(
                                personaName.trim(),
                                personaAvatar,
                                personaText.trim()
                            ).then(() => { showPersonaModal = false; });
                        }
                    " x-text="editingPersonaId ? '‰øùÂ≠ò' : 'ÂàõÂª∫'"></button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js?v=1.3.4"></script>
    <script src="version-update.js?v=1.3.0"></script>
</body>
</html>