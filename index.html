<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>RuaPhone</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.6.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=1.18.0">
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
</head>
<body>
    <div class="phone-frame" x-data="phoneApp()" x-init="init()">
        <!-- Status Bar -->
        <div class="status-bar">
            <div x-text="currentTime"></div>
            <div class="battery">
                <span x-text="batteryLevel + '%'"></span>
                <div class="battery-icon">
                    <div class="battery-level" :style="`width: ${batteryLevel}%`"></div>
                </div>
            </div>
        </div>

        <!-- Screen Content -->
        <div class="screen">
            <div class="page-container">
                <!-- Home Screen -->
                <div class="page home-screen" :class="{ active: $store.app.currentPage === 'home' }">
                    <div class="clock">
                        <div class="clock-time" x-text="currentTime"></div>
                        <div class="clock-date" x-text="currentDate"></div>
                    </div>
                    
                    <div class="app-grid">
                        <div class="app-icon" @click="navigateTo('chat-list')">
                            <div class="app-icon-image">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="app-icon-label">聊天</div>
                        </div>

                        <div class="app-icon" @click="navigateTo('moments')" data-testid="moments-icon">
                            <div class="app-icon-image">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="app-icon-label">朋友圈</div>
                        </div>

                        <!-- <div class="app-icon" @click="navigateTo('settings')">
                            <div class="app-icon-image">
                                <i class="fas fa-palette"></i>
                            </div>
                            <div class="app-icon-label">主题</div>
                        </div> -->
                        
                        <div class="app-icon" @click="navigateTo('world-book')">
                            <div class="app-icon-image">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="app-icon-label">世界书</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('personas')">
                            <div class="app-icon-image">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <div class="app-icon-label">通讯录</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('profile')">
                            <div class="app-icon-image">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="app-icon-label">个人资料</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('api-settings')">
                            <div class="app-icon-image">
                                <i class="fas fa-key"></i>
                            </div>
                            <div class="app-icon-label">API设置</div>
                        </div>
                        
                        
                    </div>
                    
                    <!-- Version info -->
                    <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: #999; font-size: 10px; text-align: center;">
                        RuaPhone v1.18.0
                    </div>
                </div>

                <!-- Chat List Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'chat-list' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">聊天</div>
                        <div class="header-actions">
                            <button class="header-button" @click="$dispatch('open-create-chat')" title="私聊">
                                <i class="fas fa-user"></i>
                            </button>
                            <button class="header-button" @click="$dispatch('open-create-group-chat')" title="群聊">
                                <i class="fas fa-users"></i>
                            </button>
                        </div>
                    </div>
                    <div class="content">
                        <div class="list-container" x-show="$store.chat.chats.length > 0">
                            <template x-for="chat in $store.chat.chats" :key="chat.id">
                                <div class="swipe-container" 
                                     x-data="{
                                         startX: 0,
                                         currentX: 0,
                                         isDragging: false,
                                         isOpen: false,
                                         threshold: 80,
                                         
                                         get swipeStyle() {
                                             const translateX = this.isOpen ? -80 : Math.max(-80, Math.min(0, this.currentX - this.startX));
                                             return `transform: translateX(${translateX}px); transition: ${this.isDragging ? 'none' : 'transform 0.3s ease'};`;
                                         },
                                         
                                         handleTouchStart(e) {
                                             this.startX = e.touches[0].clientX;
                                             this.currentX = e.touches[0].clientX;
                                             this.isDragging = true;
                                         },
                                         
                                         handleTouchMove(e) {
                                             if (!this.isDragging) return;
                                             this.currentX = e.touches[0].clientX;
                                             e.preventDefault(); // 防止页面滚动
                                         },
                                         
                                         handleTouchEnd(e) {
                                             if (!this.isDragging) return;
                                             this.isDragging = false;
                                             const diff = this.startX - this.currentX;
                                             
                                             if (diff > this.threshold) {
                                                 this.isOpen = true;
                                             } else {
                                                 this.isOpen = false;
                                             }
                                         },
                                         
                                         handleMouseDown(e) {
                                             this.startX = e.clientX;
                                             this.currentX = e.clientX;
                                             this.isDragging = true;
                                             e.preventDefault();
                                         },
                                         
                                         handleMouseMove(e) {
                                             if (!this.isDragging) return;
                                             this.currentX = e.clientX;
                                         },
                                         
                                         handleMouseUp(e) {
                                             if (!this.isDragging) return;
                                             this.isDragging = false;
                                             const diff = this.startX - this.currentX;
                                             
                                             if (diff > this.threshold) {
                                                 this.isOpen = true;
                                             } else {
                                                 this.isOpen = false;
                                             }
                                         },
                                         
                                         handleClick(e) {
                                             if (this.isOpen) {
                                                 e.stopPropagation();
                                                 this.isOpen = false;
                                             } else {
                                                 openChat(chat.id);
                                             }
                                         },
                                         
                                         deleteChat() {
                                             $store.chat.deleteChat(chat.id);
                                         }
                                     }">
                                    <div class="swipe-content" 
                                         :style="swipeStyle"
                                         @touchstart="handleTouchStart"
                                         @touchmove="handleTouchMove"
                                         @touchend="handleTouchEnd"
                                         @mousedown="handleMouseDown"
                                         @mousemove="handleMouseMove"
                                         @mouseup="handleMouseUp"
                                         @mouseleave="handleMouseUp"
                                         @click="handleClick">
                                        <div class="list-item">
                                            <div class="list-item-avatar-container"
                                                 x-data="{
                                                     getChatAvatar() {
                                                         // For single chat, get dynamic avatar from persona
                                                         if (chat.type !== 'group' && chat.personaId) {
                                                             const persona = $store.personas.personas.find(p => p.id === chat.personaId);
                                                             if (persona?.avatar) {
                                                                 return persona.avatar;
                                                             }
                                                         }
                                                         // Fallback to chat avatar or placeholder
                                                         return chat.avatar || 'https://via.placeholder.com/40';
                                                     }
                                                 }">
                                                <img x-show="getChatAvatar() && getChatAvatar() !== 'https://via.placeholder.com/40'" 
                                                     :src="getChatAvatar()" 
                                                     :alt="chat.name"
                                                     class="list-item-avatar">
                                                <div x-show="chat.type === 'group'" class="group-indicator">
                                                    <i class="fas fa-users"></i>
                                                </div>
                                            </div>
                                            <div class="list-item-content">
                                                <div class="list-item-title">
                                                    <span x-text="chat.name"></span>
                                                    <span x-show="chat.type === 'group' && chat.personaIds" 
                                                          class="chat-member-count"
                                                          x-text="`(${chat.personaIds?.length || 0})`"></span>
                                                </div>
                                                <div class="list-item-subtitle" x-text="chat.lastMessage || '暂无消息'"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="swipe-actions">
                                        <button class="delete-btn" @click="deleteChat()">
                                            <i class="fas fa-trash"></i>
                                            删除
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="$store.chat.chats.length === 0" class="text-center p-4">
                            <p class="text-secondary">暂无聊天记录</p>
                            <div class="button-group mt-4">
                                <button class="button" @click="$dispatch('open-create-chat')">创建私聊</button>
                                <button class="button" @click="$dispatch('open-create-group-chat')">创建群聊</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Interface Page -->
                <div class="page chat-page" :class="{ active: $store.app.currentPage === 'chat' }" x-data="chatInterface()">
                    <div class="header">
                        <button class="header-button" @click="$store.app.navigateTo('chat-list')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">
                            <span x-text="$store.app.isLoading ? '对方正在输入...' : (currentChat?.name || '聊天')"></span>
                            <span x-show="currentChat?.type === 'group' && currentChat?.personaIds" 
                                  class="group-member-count"
                                  x-text="`(${currentChat?.personaIds?.length || 0}人)`"></span>
                        </div>
                        <div style="width: 32px;"></div>
                    </div>
                    
                    <!-- Messages Container -->
                    <div class="chat-messages" x-ref="messagesContainer">
                        <template x-for="message in messages" :key="message.id">
                            <div class="message-wrapper" :class="{ 'user': message.role === 'user', 'ai': message.role === 'assistant' }">
                                
                                <!-- Recall Message (system message style) -->
                                <template x-if="message.type === 'recall'">
                                    <div class="message-recall">
                                        <span x-text="(message.senderName || (message.role === 'user' ? '你' : '对方')) + '撤回了一条消息'"></span>
                                    </div>
                                </template>
                                
                                <!-- Regular Messages -->
                                <template x-if="message.type !== 'recall'">
                                    <div class="message message-bubble" 
                                         :class="{ 
                                             'user': message.role === 'user', 
                                             'assistant': message.role === 'assistant',
                                             'ai': message.role === 'assistant',
                                             'message-text': message.type === 'text' || !message.type,
                                             'message-voice': message.type === 'voice',
                                             'message-image': message.type === 'image',
                                             'message-transfer': message.type === 'transfer',
                                             'message-sticker': message.type === 'sticker',
                                             'message-html': message.type === 'html'
                                         }">
                                        
                                        <!-- Avatar -->
                                        <div class="avatar avatar-group">
                                            <div x-show="message.role === 'user'" class="user-avatar">
                                                <img x-show="$store.profile.profile.avatar" 
                                                     :src="$store.profile.profile.avatar" 
                                                     alt="我的头像"
                                                     class="user-avatar-img"
                                                     @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='inline';">
                                                <span x-show="!$store.profile.profile.avatar">👤</span>
                                            </div>
                                            <div x-show="message.role === 'assistant'" class="ai-avatar"
                                                 x-data="{
                                                     getGroupMemberAvatar() {
                                                         if (currentChat?.type === 'group' && message.senderName) {
                                                             // Dynamically get avatar from personas store
                                                             const persona = $store.personas.personas.find(p => p.name === message.senderName);
                                                             return persona?.avatar || 'https://via.placeholder.com/40';
                                                         }
                                                         // For single chat, dynamically get avatar from persona
                                                         if (currentChat?.personaId) {
                                                             const persona = $store.personas.personas.find(p => p.id === currentChat.personaId);
                                                             if (persona?.avatar) {
                                                                 return persona.avatar;
                                                             }
                                                         }
                                                         // Fallback to chat avatar or placeholder
                                                         return currentChat?.avatar || 'https://via.placeholder.com/40';
                                                     }
                                                 }">
                                                <img x-show="getGroupMemberAvatar() && getGroupMemberAvatar() !== 'https://via.placeholder.com/40'" 
                                                     :src="getGroupMemberAvatar()" 
                                                     :alt="message.senderName || currentChat?.name"
                                                     @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='inline';">
                                                <span x-show="!getGroupMemberAvatar() || getGroupMemberAvatar() === 'https://via.placeholder.com/40'">🤖</span>
                                            </div>
                                        </div>

                                        <!-- Message Content -->
                                        <div class="message-content content" 
                                             :class="{ 'no-bubble': message.type === 'voice' || message.type === 'image' || message.type === 'transfer' || message.type === 'sticker' || message.type === 'html' }"
                                             @pointerdown="$store.messageTooltip.startLongPress($event, $el, message.id)"
                                             @pointerup="$store.messageTooltip.endLongPress()"
                                             @pointercancel="$store.messageTooltip.cancelLongPress()"
                                             @pointerleave="$store.messageTooltip.cancelLongPress()"
                                             @pointermove="$store.messageTooltip.moveLongPress($event)"
                                             @contextmenu.prevent="$store.messageTooltip.showForMessage($el, message.id)"
                                             style="user-select: none; -webkit-touch-callout: none; touch-action: manipulation;">
                                            
                                            <!-- Text Message -->
                                            <template x-if="message.type === 'text' || !message.type">
                                                <div class="message-text-content" x-data="{ 
                                                    parseQuote(content) {
                                                        const quoteMatch = content?.match(/^quote<([^>]*)>(.*)/s);
                                                        if (quoteMatch) {
                                                            return {
                                                                quoted: quoteMatch[1],
                                                                text: quoteMatch[2]
                                                            };
                                                        }
                                                        return null;
                                                    },
                                                    get parsedContent() {
                                                        const msgContent = message.content || '消息内容为空';
                                                        return this.parseQuote(msgContent);
                                                    },
                                                    get isEditing() {
                                                        return $store.chat.editingMessageId === message.id;
                                                    }
                                                }">
                                                    <!-- Edit mode -->
                                                    <div x-show="isEditing" class="message-edit-mode">
                                                        <textarea 
                                                            x-model="$store.chat.editingContent"
                                                            @keydown.escape="$store.chat.cancelEdit()"
                                                            @keydown.enter.ctrl="$store.chat.saveEdit()"
                                                            @keydown.enter.meta="$store.chat.saveEdit()"
                                                            class="message-edit-input"
                                                            :placeholder="message.content"
                                                            x-init="$el.focus(); $el.setSelectionRange($el.value.length, $el.value.length)"
                                                            rows="2"></textarea>
                                                        <button @click="$store.chat.saveEdit()" class="message-edit-save" title="保存">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    </div>
                                                    
                                                    <!-- Normal display mode -->
                                                    <div x-show="!isEditing">
                                                        <!-- Group chat sender name -->
                                                        <div x-show="message.senderName" class="group-sender-name" x-text="message.senderName"></div>
                                                        
                                                        <!-- Message with quote -->
                                                        <div x-show="parsedContent">
                                                            <div class="quoted-content">
                                                                <div class="quote-bar"></div>
                                                                <div class="quote-text" x-text="parsedContent?.quoted"></div>
                                                            </div>
                                                            <div class="message-text" x-text="parsedContent?.text"></div>
                                                        </div>
                                                        <!-- Regular message without quote -->
                                                        <div x-show="!parsedContent" class="message-text" x-text="message.content || '消息内容为空'"></div>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Voice Message -->
                                            <template x-if="message.type === 'voice'">
                                                <div class="voice-message" @click="playVoiceMessage(message)">
                                                    <div class="voice-icon">🎤</div>
                                                    <div class="voice-waveform">
                                                        <span></span><span></span><span></span><span></span><span></span>
                                                    </div>
                                                    <div class="voice-duration" x-text="(message.voiceDuration || 1) + '″'"></div>
                                                </div>
                                            </template>
                                            
                                            <!-- Image Message -->
                                            <template x-if="message.type === 'image'">
                                                <div class="image-message">
                                                    <img :src="message.imageUrl" 
                                                         :alt="message.content || '图片'"
                                                         @click="viewImage(message.imageUrl)"
                                                         @error="$event.target.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+5Zu+54mH5LiN5a2Y5ZyoPC90ZXh0Pjwvc3ZnPg=='; $event.target.style.maxWidth='200px'; $event.target.style.maxHeight='100px';">
                                                </div>
                                            </template>
                                            
                                            <!-- Transfer Message -->
                                            <template x-if="message.type === 'transfer'">
                                                <div class="transfer-message">
                                                    <div class="transfer-icon">💰</div>
                                                    <div class="transfer-content">
                                                        <div class="transfer-title" x-text="message.role === 'user' ? '转账给对方' : '收到转账'"></div>
                                                        <div class="transfer-amount">¥<span x-text="(message.transferAmount || 0).toFixed(2)"></span></div>
                                                        <div class="transfer-note" x-text="message.transferNote || (message.role === 'user' ? '转账给你' : '对方转账给你')"></div>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Sticker Message -->
                                            <template x-if="message.type === 'sticker'">
                                                <div class="sticker-message">
                                                    <img :src="message.stickerUrl" 
                                                         :alt="message.content || '表情'"
                                                         @error="$event.target.style.display='none'">
                                                </div>
                                            </template>
                                            
                                            <!-- HTML Message -->
                                            <template x-if="message.type === 'html'">
                                                <div class="html-message" x-data="{
                                                    iframeId: 'html-msg-' + message.id,
                                                    scale: 1,
                                                    originalSize: false,
                                                    autoResize() {
                                                        const iframe = document.getElementById(this.iframeId);
                                                        const container = iframe?.parentElement;
                                                        if (iframe && iframe.contentWindow && container) {
                                                            try {
                                                                const body = iframe.contentWindow.document.body;
                                                                const html = iframe.contentWindow.document.documentElement;
                                                                
                                                                // 获取内容实际尺寸
                                                                const contentHeight = Math.max(
                                                                    body.scrollHeight, body.offsetHeight,
                                                                    html.scrollHeight, html.offsetHeight
                                                                );
                                                                const contentWidth = Math.max(
                                                                    body.scrollWidth, body.offsetWidth,
                                                                    html.scrollWidth, html.offsetWidth
                                                                );
                                                                
                                                                // 设置iframe原始尺寸
                                                                iframe.style.width = contentWidth + 'px';
                                                                iframe.style.height = contentHeight + 'px';
                                                                
                                                                // 获取容器最大尺寸
                                                                const maxWidth = 320;
                                                                const maxHeight = 450;
                                                                
                                                                // 计算缩放比例
                                                                if (contentWidth > maxWidth || contentHeight > maxHeight) {
                                                                    const scaleX = maxWidth / contentWidth;
                                                                    const scaleY = maxHeight / contentHeight;
                                                                    this.scale = Math.min(scaleX, scaleY);
                                                                    
                                                                    // 应用缩放
                                                                    iframe.style.transform = `scale(${this.scale})`;
                                                                    iframe.style.transformOrigin = 'top left';
                                                                    
                                                                    // 调整容器高度以适应缩放后的内容
                                                                    container.style.height = (contentHeight * this.scale) + 'px';
                                                                    container.style.width = (contentWidth * this.scale) + 'px';
                                                                } else {
                                                                    this.scale = 1;
                                                                    iframe.style.transform = 'none';
                                                                    container.style.height = contentHeight + 'px';
                                                                    container.style.width = contentWidth + 'px';
                                                                }
                                                            } catch(e) {
                                                                console.log('Cannot resize iframe:', e);
                                                            }
                                                        }
                                                    },
                                                    toggleSize() {
                                                        const iframe = document.getElementById(this.iframeId);
                                                        const container = iframe?.parentElement;
                                                        if (!iframe || !container) return;
                                                        
                                                        this.originalSize = !this.originalSize;
                                                        if (this.originalSize) {
                                                            // 显示原始尺寸
                                                            iframe.style.transform = 'none';
                                                            container.style.overflow = 'auto';
                                                            container.style.maxWidth = '100%';
                                                            container.style.maxHeight = '80vh';
                                                        } else {
                                                            // 恢复缩放
                                                            this.autoResize();
                                                            container.style.overflow = 'hidden';
                                                        }
                                                    }
                                                }" @dblclick="toggleSize()">
                                                    <iframe 
                                                        :id="iframeId"
                                                        :srcdoc="message.content"
                                                        sandbox="allow-scripts allow-forms allow-modals allow-same-origin"
                                                        scrolling="no"
                                                        frameborder="0"
                                                        @load="autoResize()"
                                                        style="min-height: 100px; border-radius: 12px; background: white;">
                                                    </iframe>
                                                    <div x-show="scale < 1 && !originalSize" class="scale-indicator">
                                                        <i class="fas fa-search-minus"></i> 
                                                        <span x-text="Math.round(scale * 100) + '%'"></span>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Message Time -->
                                            <div class="message-time" x-text="formatTime(message.timestamp)"></div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        
                    </div>
                    
                    <!-- Message Tooltip -->
                    <template x-if="$store.messageTooltip.show">
                        <div>
                            <!-- Backdrop -->
                            <div class="message-tooltip-backdrop" 
                                 @click="$store.messageTooltip.hide()"
                                 @wheel="$store.messageTooltip.hide()"></div>
                            
                            <!-- Tooltip Card -->
                            <div class="message-tooltip-menu" 
                                 :class="$store.messageTooltip.placement"
                                 role="menu" 
                                 aria-label="消息菜单"
                                 :style="`left: ${$store.messageTooltip.x}px; top: ${$store.messageTooltip.y}px;`"
                                 @keydown.escape.window="$store.messageTooltip.hide()">
                                <div class="message-tooltip-card">
                                    <button role="menuitem" @click="$store.messageTooltip.quoteMessage()">
                                        <i class="fas fa-quote-left"></i>
                                        <span>引用</span>
                                    </button>
                                    <button role="menuitem" @click="$store.messageTooltip.editMessage()">
                                        <i class="fas fa-edit"></i>
                                        <span>编辑</span>
                                    </button>
                                    <button role="menuitem" @click="$store.messageTooltip.deleteMessage()">
                                        <i class="fas fa-trash"></i>
                                        <span>删除</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Input Area -->
                    <div class="chat-input" 
                         x-data="{
                             showVoiceInput: false, 
                             showTransferDialog: false, 
                             voiceText: '', 
                             transferAmount: '', 
                             transferNote: '',
                             showImageInput: false,
                             
                             async sendVoiceMessage() {
                                 const chatId = Alpine.store('app').currentChatId;
                                 
                                 if (!this.voiceText.trim()) return;
                                 
                                 const voiceMessage = {
                                     type: 'voice',
                                     content: this.voiceText.trim(),
                                     voiceDuration: Math.ceil(this.voiceText.length / 5)
                                 };
                                 
                                 await Alpine.store('chat').sendMessage(chatId, voiceMessage);
                                 
                                 // Reset and close modal
                                 this.voiceText = '';
                                 this.showVoiceInput = false;
                                 
                                 // Scroll to bottom
                                 this.$nextTick(() => {
                                     const container = this.$el.closest('.chat-page').querySelector('[x-ref=messagesContainer]');
                                     if (container) {
                                         container.scrollTop = container.scrollHeight;
                                     }
                                 });
                             },
                             
                             async sendTransferMessage() {
                                 const chatId = Alpine.store('app').currentChatId;
                                 
                                 const amount = parseFloat(this.transferAmount);
                                 const note = this.transferNote.trim();
                                 
                                 if (isNaN(amount) || amount <= 0 || amount > 9999) {
                                     alert('请输入有效的金额 (0-9999)');
                                     return;
                                 }
                                 
                                 const transferMessage = {
                                     type: 'transfer',
                                     transferAmount: amount,
                                     transferNote: note || '转账给你',
                                     content: `[转账] ¥${amount.toFixed(2)}`
                                 };
                                 
                                 await Alpine.store('chat').sendMessage(chatId, transferMessage);
                                 
                                 // Reset inputs and close modal
                                 this.transferAmount = '';
                                 this.transferNote = '';
                                 this.showTransferDialog = false;
                                 
                                 // Scroll to bottom
                                 this.$nextTick(() => {
                                     const container = this.$el.closest('.chat-page').querySelector('[x-ref=messagesContainer]');
                                     if (container) {
                                         container.scrollTop = container.scrollHeight;
                                     }
                                 });
                             },
                             
                             async handleImageSelect(event) {
                                 const file = event.target.files[0];
                                 if (!file) return;
                                 
                                 try {
                                     const base64 = await window.fileToBase64(file);
                                     const chatId = Alpine.store('app').currentChatId;
                                     
                                     const imageMessage = {
                                         type: 'image',
                                         imageUrl: base64,
                                         content: `[图片] ${file.name}`
                                     };
                                     
                                     await Alpine.store('chat').sendMessage(chatId, imageMessage);
                                     
                                     // Clear file input
                                     event.target.value = '';
                                     
                                     // Scroll to bottom
                                     this.$nextTick(() => {
                                         const container = this.$el.closest('.chat-page').querySelector('[x-ref=messagesContainer]');
                                         if (container) {
                                             container.scrollTop = container.scrollHeight;
                                         }
                                     });
                                     
                                 } catch (error) {
                                     console.error('Image upload error:', error);
                                     alert('图片上传失败: ' + error.message);
                                 }
                             }
                         }">
                        
                        <!-- Input Toolbar -->
                        <div class="input-toolbar">
                            <button @click="showVoiceInput = true" class="toolbar-button" title="语音消息">
                                <i class="ri-mic-line"></i>
                            </button>
                            <button @click="$refs.imageInput.click()" class="toolbar-button" title="图片">
                                <i class="ri-image-line"></i>
                            </button>
                            <button @click="showTransferDialog = true" class="toolbar-button" title="转账">
                                <i class="ri-money-cny-box-line"></i>
                            </button>
                        </div>
                        
                        <!-- Quoted Message Display -->
                        <div x-show="$store.chat.quotedMessage" 
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 transform translate-y-full"
                             x-transition:enter-end="opacity-100 transform translate-y-0"
                             x-transition:leave="transition ease-in duration-150"
                             x-transition:leave-start="opacity-100 transform translate-y-0"
                             x-transition:leave-end="opacity-0 transform translate-y-full"
                             class="quoted-message-bar">
                            <div class="quoted-message-content">
                                <div class="quoted-message-indicator">
                                    <i class="fas fa-reply"></i>
                                    <span>回复</span>
                                    <span class="quoted-name" x-text="$store.chat.quotedMessage?.role === 'user' ? '我' : 'AI'"></span>
                                </div>
                                <div class="quoted-text" x-text="$store.chat.quotedMessage?.content?.substring(0, 50) + ($store.chat.quotedMessage?.content?.length > 50 ? '...' : '')"></div>
                            </div>
                            <button class="quoted-message-close" @click="$store.chat.quotedMessage = null">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Main Input Container -->
                        <div class="chat-input-wrapper">
                            <div class="input-container">
                                <input 
                                    type="text" 
                                    x-model="newMessage" 
                                    @keydown.enter="sendMessage()"
                                    placeholder="输入消息..."
                                    class="message-input"
                                >
                            </div>
                            <div class="button-group">
                                <button @click="triggerAIResponse()" class="ai-button" :disabled="!hasUserMessages()">
                                    <i class="ri-chat-ai-line"></i>
                                </button>
                                <button @click="sendMessage()" class="send-button" :disabled="!newMessage.trim()">
                                    <i class="ri-send-plane-fill"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Voice Input Modal -->
                        <div x-show="showVoiceInput" 
                             x-transition
                             class="input-modal"
                             @click.away="showVoiceInput = false">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>发送语音消息</h3>
                                    <button @click="showVoiceInput = false" class="close-button">✕</button>
                                </div>
                                <textarea 
                                    x-model="voiceText" 
                                    placeholder="输入语音消息内容..."
                                    class="voice-textarea"
                                    rows="3"></textarea>
                                <div class="modal-buttons">
                                    <button @click="showVoiceInput = false" class="cancel-button">取消</button>
                                    <button @click="sendVoiceMessage()" class="confirm-button">发送</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transfer Dialog -->
                        <div x-show="showTransferDialog" 
                             x-transition
                             class="input-modal"
                             @click.away="showTransferDialog = false">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>发送转账</h3>
                                    <button @click="showTransferDialog = false" class="close-button">✕</button>
                                </div>
                                <div class="transfer-form">
                                    <div class="form-group">
                                        <label>转账金额</label>
                                        <input type="number" 
                                               x-model="transferAmount" 
                                               placeholder="0.00" 
                                               min="0" 
                                               max="9999"
                                               step="0.01"
                                               class="transfer-input">
                                    </div>
                                    <div class="form-group">
                                        <label>转账备注</label>
                                        <input type="text" 
                                               x-model="transferNote" 
                                               placeholder="转账给你"
                                               class="transfer-input">
                                    </div>
                                </div>
                                <div class="modal-buttons">
                                    <button @click="showTransferDialog = false" class="cancel-button">取消</button>
                                    <button @click="sendTransferMessage()" class="confirm-button">确认转账</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Image Input -->
                        <input type="file" 
                               accept="image/*" 
                               @change="handleImageSelect($event)"
                               x-ref="imageInput" 
                               style="display: none;">
                    </div>
                </div>

                <!-- Profile Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'profile' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">个人资料</div>
                        <button class="header-button profile-save-btn" @click="saveProfile()" :disabled="profileSaving">
                            <template x-if="!profileSaving">
                                <span>保存</span>
                            </template>
                            <template x-if="profileSaving">
                                <i class="fas fa-spinner fa-spin"></i>
                            </template>
                        </button>
                    </div>
                    <div class="content profile-content">
                        <!-- Avatar Section -->
                        <div class="profile-avatar-section">
                            <div class="profile-avatar-container" @click="$refs.avatarInput.click()">
                                <img x-show="$store.profile.profile.avatar" 
                                     :src="$store.profile.profile.avatar" 
                                     alt="头像"
                                     class="profile-avatar">
                                <div x-show="!$store.profile.profile.avatar" class="profile-avatar-placeholder">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="profile-avatar-overlay">
                                    <i class="fas fa-camera"></i>
                                </div>
                            </div>
                            <input type="file" 
                                   x-ref="avatarInput" 
                                   @change="handleAvatarUpload($event)" 
                                   accept="image/*" 
                                   style="display: none;">
                        </div>
                        
                        <!-- Profile Form -->
                        <div class="profile-form">
                            <div class="form-group">
                                <label class="form-label">姓名</label>
                                <input type="text" 
                                       class="form-input" 
                                       x-model="$store.profile.profile.name" 
                                       placeholder="请输入您的姓名">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">性别</label>
                                <input type="text" 
                                       class="form-input" 
                                       x-model="$store.profile.profile.gender" 
                                       placeholder="请输入您的性别">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">年龄</label>
                                <input type="number" 
                                       class="form-input" 
                                       x-model="$store.profile.profile.age" 
                                       placeholder="请输入您的年龄"
                                       min="1" 
                                       max="150">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">个人介绍</label>
                                <textarea class="form-input profile-bio" 
                                          x-model="$store.profile.profile.bio" 
                                          placeholder="介绍一下自己吧..."
                                          rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Settings Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'api-settings' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">API设置</div>
                        <div style="width: 32px;"></div>
                    </div>
                    <div class="content">
                        <!-- Version Display -->
                        <div class="version-info" style="
                            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
                            color: white;
                            padding: 12px 16px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            text-align: center;
                            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
                        ">
                            <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">
                                🚀 RuaPhone v1.18.0
                            </div>
                            <div style="font-size: 12px; opacity: 0.9;">
                                可爱的小手机rua~
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">API类型</label>
                            <select class="form-input" x-model="$store.settings.apiConfig.apiType" 
                                @change="$store.settings.updateApiType($event.target.value)">
                                <option value="openai">OpenAI （api站选这个）</option>
                                <option value="gemini">Google Gemini</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">API地址</label>
                            <input type="text" class="form-input" x-model="$store.settings.apiConfig.baseURL" 
                                :placeholder="$store.settings.apiConfig.apiType === 'gemini' ? '自动使用 Google 官方 API' : 'https://api.openai.com'"
                                :disabled="$store.settings.apiConfig.apiType === 'gemini'">
                            <small class="form-help" x-show="$store.settings.apiConfig.apiType !== 'gemini'">
                                结尾有没有/v1都可以
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">API密钥</label>
                            <input type="password" class="form-input" x-model="$store.settings.apiConfig.apiKey" 
                                :placeholder="$store.settings.apiConfig.apiType === 'gemini' ? 'AIza...' : 'sk-...'">
                            <small class="form-help">支持多个密钥，用逗号分隔</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">模型</label>
                            
                            <!-- Gemini Models (Dynamic) -->
                            <template x-if="$store.settings.apiConfig.apiType === 'gemini'">
                                <div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select class="form-input" x-model="$store.settings.apiConfig.model" style="flex: 1;">
                                            <option value="" disabled>
                                                <span x-show="$store.settings.modelsLoading">正在加载模型...</span>
                                                <span x-show="!$store.settings.modelsLoading && $store.settings.availableModels.length === 0">请先配置 Gemini API 密钥</span>
                                            </option>
                                            <template x-for="model in $store.settings.availableModels" :key="model.id">
                                                <option :value="model.id" x-text="model.name || model.id"></option>
                                            </template>
                                        </select>
                                        <button type="button" 
                                            class="button" 
                                            style="padding: 8px 12px; font-size: 14px; background: #007AFF;" 
                                            @click="$store.settings.refreshModels()"
                                            :disabled="$store.settings.modelsLoading"
                                            :class="{ 'opacity-50 cursor-not-allowed': $store.settings.modelsLoading }">
                                            拉取
                                        </button>
                                    </div>
                                    
                                    <!-- Loading indicator -->
                                    <div x-show="$store.settings.modelsLoading" 
                                        class="form-help" 
                                        style="color: #007AFF; margin-top: 8px;">
                                        <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                                        正在从 Gemini API 获取模型列表...
                                    </div>
                                    
                                    <!-- Error message -->
                                    <div x-show="$store.settings.modelsError" 
                                        class="form-help" 
                                        style="color: #FF3B30; margin-top: 8px;">
                                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                                        <span x-text="$store.settings.modelsError"></span>
                                    </div>
                                    
                                    <!-- Success message -->
                                    <div x-show="!$store.settings.modelsError && !$store.settings.modelsLoading && $store.settings.availableModels.length > 0" 
                                        class="form-help" 
                                        style="color: #34C759; margin-top: 8px;">
                                        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                                        已获取 <span x-text="$store.settings.availableModels.length"></span> 个 Gemini 模型
                                    </div>
                                </div>
                            </template>
                            
                            <!-- OpenAI-compatible Models -->
                            <template x-if="$store.settings.apiConfig.apiType !== 'gemini'">
                                <div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select class="form-input" x-model="$store.settings.apiConfig.model" style="flex: 1;">
                                            <option value="" disabled>
                                                <span x-show="$store.settings.modelsLoading">正在加载模型...</span>
                                                <span x-show="!$store.settings.modelsLoading && $store.settings.availableModels.length === 0">请先配置API地址和密钥</span>
                                            </option>
                                            <template x-for="model in $store.settings.availableModels" :key="model.id">
                                                <option :value="model.id" x-text="model.id"></option>
                                            </template>
                                        </select>
                                        <button type="button" 
                                            class="button" 
                                            style="padding: 8px 12px; font-size: 14px; background: #007AFF;" 
                                            @click="$store.settings.refreshModels()"
                                            :disabled="$store.settings.modelsLoading"
                                            :class="{ 'opacity-50 cursor-not-allowed': $store.settings.modelsLoading }">
                                            拉取
                                        </button>
                                    </div>
                                    
                                    <!-- Loading indicator -->
                                    <div x-show="$store.settings.modelsLoading" 
                                        class="form-help" 
                                        style="color: #007AFF; margin-top: 8px;">
                                        <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                                        正在从 API 获取模型列表...
                                    </div>
                                    
                                    <!-- Error message -->
                                    <div x-show="$store.settings.modelsError" 
                                        class="form-help" 
                                        style="color: #FF3B30; margin-top: 8px;">
                                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                                        <span x-text="$store.settings.modelsError"></span>
                                    </div>
                                    
                                    <!-- Success message -->
                                    <div x-show="!$store.settings.modelsError && !$store.settings.modelsLoading && $store.settings.availableModels.length > 0" 
                                        class="form-help" 
                                        style="color: #34C759; margin-top: 8px;">
                                        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                                        已加载 <span x-text="$store.settings.availableModels.length"></span> 个模型
                                        <span x-show="$store.settings.modelsLastFetch">
                                            (缓存 5 分钟)
                                        </span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <template x-if="$store.settings.apiConfig.apiType === 'gemini'">
                            <div class="form-group">
                                <div class="form-help" style="background: #e8f4fd; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                    <p style="margin: 0 0 8px 0; font-weight: 500;">📋 使用说明：</p>
                                    <p style="margin: 0 0 4px 0;">1. 访问 <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #1976d2;">Google AI Studio</a> 获取免费API密钥</p>
                                    <p style="margin: 0 0 4px 0;">2. API密钥格式：AIza开头的字符串</p>
                                    <p style="margin: 0;">3. 推荐使用Gemini 2.5</p>
                                </div>
                            </div>
                        </template>
                        <button class="button" @click="saveApiConfig()">保存设置</button>
                        
                        <!-- Minimax Voice API Settings Section -->
                        <div class="form-section" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #E5E5EA;">
                            <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1C1C1E;">Minimax 语音API设置</h3>
                            
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" 
                                           x-model="$store.settings.voiceApiConfig.voiceEnabled"
                                           style="width: 18px; height: 18px;">
                                    <span>启用语音合成功能</span>
                                </label>
                                <small class="form-help">开启后，AI发送的语音消息将合成为真实语音</small>
                            </div>
                            
                            <div x-show="$store.settings.voiceApiConfig.voiceEnabled" 
                                 x-transition:enter="transition ease-out duration-300"
                                 x-transition:enter-start="opacity-0 transform -translate-y-2"
                                 x-transition:enter-end="opacity-100 transform translate-y-0"
                                 x-transition:leave="transition ease-in duration-200"
                                 x-transition:leave-start="opacity-100"
                                 x-transition:leave-end="opacity-0">
                                
                                <div class="form-group">
                                    <label class="form-label">API Key <span style="color: #FF3B30;">*</span></label>
                                    <input type="password" 
                                           class="form-input" 
                                           x-model="$store.settings.voiceApiConfig.minimaxApiKey" 
                                           placeholder="请输入Minimax API Key">
                                    <small class="form-help">从Minimax平台获取的API密钥</small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Group ID <span style="color: #FF3B30;">*</span></label>
                                    <input type="text" 
                                           class="form-input" 
                                           x-model="$store.settings.voiceApiConfig.minimaxGroupId" 
                                           placeholder="请输入Group ID">
                                    <small class="form-help">Minimax平台提供的Group ID</small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">语音模型</label>
                                    <select class="form-input" x-model="$store.settings.voiceApiConfig.minimaxModel">
                                        <template x-for="model in $store.settings.voiceModels" :key="model.id">
                                            <option :value="model.id" x-text="model.name"></option>
                                        </template>
                                    </select>
                                    <small class="form-help">选择语音合成模型，推荐使用默认的 Speech 2.5 HD Preview</small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">语音角色</label>
                                    <select class="form-input" x-model="$store.settings.voiceApiConfig.voiceId">
                                        <template x-for="voice in $store.settings.voiceCharacters" :key="voice.id">
                                            <option :value="voice.id" x-text="voice.name"></option>
                                        </template>
                                    </select>
                                    <small class="form-help">选择语音角色，不同角色有不同的音色特点</small>
                                </div>
                                
                                <div class="form-help" style="background: #e8f4fd; padding: 12px; border-radius: 8px; margin-top: 16px;">
                                    <p style="margin: 0 0 8px 0; font-weight: 500;">📋 使用说明：</p>
                                    <p style="margin: 0 0 4px 0;">1. 访问 <a href="https://platform.minimaxi.com" target="_blank" style="color: #1976d2;">Minimax平台</a> 获取API密钥和Group ID</p>
                                    <p style="margin: 0 0 4px 0;">2. 启用后，点击语音消息会自动合成并播放真实语音</p>
                                    <p style="margin: 0;">3. 已合成的语音会自动缓存，避免重复请求</p>
                                </div>
                            </div>
                            
                            <button class="button" 
                                    style="margin-top: 16px; background: #FF6B35;" 
                                    @click="saveVoiceApiConfig()"
                                    x-show="$store.settings.voiceApiConfig.voiceEnabled">
                                <i class="fas fa-microphone" style="margin-right: 8px;"></i>
                                保存语音设置
                            </button>
                        </div>
                        
                        <!-- Data Management Section -->
                        <div class="form-section" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #E5E5EA;">
                            <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1C1C1E;">数据管理</h3>
                            
                            <div class="form-group">
                                <div class="form-help" style="background: #F2F2F7; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                    <p style="margin: 0 0 8px 0; font-weight: 500; color: #1C1C1E;">
                                        <span x-text="$store.app.storageStatus === 'persistent' ? '🔒 数据已持久化' : 
                                                     $store.app.storageStatus === 'not-persistent' ? '⚠️ 临时存储模式' : 
                                                     $store.app.storageStatus === 'not-supported' ? '❌ 不支持持久存储' : '🔄 检查中...'"></span>
                                    </p>
                                    <p style="margin: 0; font-size: 14px; color: #8E8E93;">
                                        <span x-show="$store.app.storageStatus === 'persistent'">您的数据已获得持久化保护，不会被自动清理。</span>
                                        <span x-show="$store.app.storageStatus === 'not-persistent'">建议申请持久化权限并定期备份数据。</span>
                                        <span x-show="$store.app.storageStatus === 'not-supported'">您的浏览器不支持持久化存储，请定期备份数据。</span>
                                    </p>
                                </div>
                            </div>
                            
                            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <button class="button" style="background: #34C759;" @click="window.exportData && window.exportData()">
                                    <i class="fas fa-download" style="margin-right: 8px;"></i>
                                    导出数据
                                </button>
                                <button class="button" style="background: #FF9500;" @click="window.importData && window.importData()">
                                    <i class="fas fa-upload" style="margin-right: 8px;"></i>
                                    导入数据
                                </button>
                            </div>
                            
                            <div class="form-group" x-show="$store.app.storageStatus !== 'persistent'">
                                <button class="button" style="background: #007AFF;" @click="$store.app.requestPersistentStorage().then(granted => {
                                    if (granted) {
                                        alert('✅ 已获得持久化存储权限！');
                                    } else {
                                        alert('⚠️ 未能获得持久化存储权限。您的数据仍可正常使用，但建议定期备份。');
                                    }
                                })">
                                    <i class="fas fa-shield-alt" style="margin-right: 8px;"></i>
                                    申请数据持久化
                                </button>
                            </div>
                            
                            <template x-if="location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.port">
                                <div class="form-group" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E5E5EA;">
                                    <button class="button" style="background: #FF3B30;" @click="window.resetDatabase && window.resetDatabase()">
                                        <i class="fas fa-trash" style="margin-right: 8px;"></i>
                                        重置数据库 (开发模式)
                                    </button>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Theme Settings Section -->
                        <div class="form-section" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #E5E5EA;">
                            <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1C1C1E;">聊天主题设置</h3>
                            
                            <div class="form-group">
                                <div class="form-help" style="background: #F2F2F7; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                    <p style="margin: 0 0 8px 0; font-weight: 500; color: #1C1C1E;">🎨 自定义聊天气泡样式</p>
                                    <p style="margin: 0; font-size: 14px; color: #8E8E93;">
                                        支持开源社区的CSS代码，可以自定义聊天气泡的样式、颜色、动画等效果。
                                    </p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">自定义CSS代码</label>
                                <textarea 
                                    class="form-input" 
                                    x-model="$store.app.globalSettings.customCSS" 
                                    placeholder="/* 在这里粘贴自定义CSS代码 */&#10;&#10;/* 示例：漂浮动画气泡 */&#10;@keyframes bubble-float {&#10;  0%, 100% { transform: translateY(0); }&#10;  50% { transform: translateY(-4px); }&#10;}&#10;&#10;.message-bubble.user .content {&#10;  background: rgba(220, 230, 225, 1);&#10;  color: #4a5550;&#10;  border-radius: 18px;&#10;  animation: bubble-float 2.5s ease-in-out infinite;&#10;}"
                                    rows="8"
                                    style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 12px; line-height: 1.4;">
                                </textarea>
                                <small class="form-help">
                                    支持 .message-bubble.user 和 .message-bubble.ai 选择器，兼容开源社区CSS代码。
                                </small>
                            </div>
                            
                            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                                <button class="button" 
                                        :style="$store.app.customCSSSaved ? 'background: #34C759;' : 'background: #007AFF;'"
                                        @click="$store.app.saveCustomCSS($store.app.globalSettings.customCSS)"
                                        :disabled="$store.app.customCSSSaving"
                                        style="font-size: 13px; padding: 8px 10px;">
                                    <template x-if="$store.app.customCSSSaving">
                                        <i class="fas fa-spinner fa-spin" style="margin-right: 6px;"></i>
                                    </template>
                                    <template x-if="!$store.app.customCSSSaving && $store.app.customCSSSaved">
                                        <i class="fas fa-check" style="margin-right: 6px;"></i>
                                    </template>
                                    <template x-if="!$store.app.customCSSSaving && !$store.app.customCSSSaved">
                                        <i class="fas fa-save" style="margin-right: 6px;"></i>
                                    </template>
                                    <span x-text="$store.app.customCSSSaving ? '保存中' : ($store.app.customCSSSaved ? '已保存' : '保存应用')"></span>
                                </button>
                                <button class="button" style="background: #FF9500; font-size: 13px; padding: 8px 10px;" @click="
                                    $store.app.globalSettings.customCSS = '';
                                    $store.app.saveCustomCSS('');
                                ">
                                    <i class="fas fa-undo" style="margin-right: 6px;"></i>
                                    重置样式
                                </button>
                                <button class="button" style="background: #34C759; font-size: 13px; padding: 8px 10px;" @click="
                                    $store.app.globalSettings.customCSS = `/* 漂浮动画 */
@keyframes bubble-float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}

/* 用户消息气泡样式 */
.message-bubble.user .content {
  position: relative;
  overflow: hidden;
  background: rgba(220, 230, 225, 1);
  color: #4a5550;
  border-radius: 18px;
  padding: 8px 12px;
  box-shadow: 0px 4px 12px 0px rgba(0, 0, 0, 0.08);
  animation: bubble-float 2.5s ease-in-out infinite;
}

/* AI回复气泡样式 */
.message-bubble.ai .content {
  background: rgba(255, 255, 255, 0.9);
  color: #333;
  border-radius: 18px;
  box-shadow: 0px 2px 8px 0px rgba(0, 0, 0, 0.1);
}`;
                                ">
                                    <i class="fas fa-magic" style="margin-right: 6px;"></i>
                                    示例样式
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- World Book Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'world-book' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">世界书</div>
                        <button class="header-button" @click="$dispatch('open-create-world-book')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="content">
                        <!-- Selection controls -->
                        <div x-show="$store.worldBook.books.length > 0" class="selection-controls">
                            <button class="button secondary small" @click="$store.worldBook.selectAll()">
                                <i class="fas fa-check-square"></i> 全选
                            </button>
                            <button class="button secondary small" @click="$store.worldBook.deselectAll()">
                                <i class="fas fa-square"></i> 全不选
                            </button>
                            <span class="enabled-count" x-text="`已启用: ${$store.worldBook.books.filter(b => b.enabled).length} / ${$store.worldBook.books.length}`"></span>
                        </div>
                        
                        <div class="list-container" x-show="$store.worldBook.books.length > 0">
                            <template x-for="book in $store.worldBook.books" :key="book.id">
                                <div class="list-item world-book-item">
                                    <div class="world-book-checkbox">
                                        <input type="checkbox" 
                                               :checked="book.enabled" 
                                               @change="$store.worldBook.toggleBook(book.id)"
                                               :id="'book-' + book.id">
                                        <label :for="'book-' + book.id"></label>
                                    </div>
                                    <div class="list-item-content" @click="editWorldBook(book.id)">
                                        <div class="list-item-title" x-text="book.name"></div>
                                        <div class="list-item-subtitle" x-text="book.content ? (book.content.substring(0, 50) + (book.content.length > 50 ? '...' : '')) : '暂无内容'"></div>
                                    </div>
                                    <div class="world-book-actions">
                                        <button class="action-btn edit-btn" @click="editWorldBook(book.id)" title="编辑">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="action-btn delete-btn" @click="
                                            if (confirm('确定要删除这个世界书吗？')) {
                                                $store.worldBook.deleteBook(book.id);
                                                showMessage('世界书已删除');
                                            }
                                        " title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="$store.worldBook.books.length === 0" class="text-center p-4">
                            <p class="text-secondary">暂无世界书</p>
                            <button class="button mt-4" @click="$dispatch('open-create-world-book')">创建世界书</button>
                        </div>
                    </div>
                </div>


                <!-- Personas Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'personas' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">通讯录</div>
                        <button class="header-button" @click="$dispatch('open-create-persona')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div class="content">
                        <div class="personas-list">
                            <template x-for="persona in $store.personas.personas" :key="persona.id">
                                <div class="persona-item">
                                    <div class="persona-avatar">
                                        <img :src="persona.avatar" :alt="persona.name" />
                                    </div>
                                    <div class="persona-info">
                                        <div class="persona-name" x-text="persona.name"></div>
                                        <div class="persona-preview" x-text="persona.persona.slice(0, 50) + (persona.persona.length > 50 ? '...' : '')"></div>
                                    </div>
                                    <div class="persona-actions">
                                        <button class="edit-button" @click="$dispatch('edit-persona', persona)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="delete-button" @click="
                                            if (confirm(`确定要删除「${persona.name}」吗？\n\n⚠️ 注意：\n• 将删除所有与该角色的私聊记录\n• 该角色将从所有群聊中移除\n• 此操作不可恢复`)) {
                                                $store.personas.deletePersona(persona.id);
                                            }
                                        ">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                            
                            <div x-show="$store.personas.personas.length === 0" class="empty-state">
                                <i class="fas fa-user-friends empty-icon"></i>
                                <div class="empty-title">暂无人设</div>
                                <div class="empty-subtitle">点击右上角 + 创建你的第一个人设</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Moments Page -->
                <div class="page moments-page" :class="{ active: $store.app.currentPage === 'moments' }" x-data="momentsInterface()">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">朋友圈</div>
                        <button class="header-button" @click="showCreateMoment()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    
                    <!-- Moments Feed -->
                    <div class="moments-feed" x-ref="momentsContainer">
                        <template x-for="moment in $store.moments.moments" :key="moment.id">
                            <div class="moment-item">
                                <!-- User Info -->
                                <div class="moment-header">
                                    <div class="moment-avatar" x-text="moment.userAvatar"></div>
                                    <div class="moment-user-info">
                                        <div class="moment-username" x-text="moment.userName"></div>
                                        <div class="moment-time" x-text="$store.moments.formatTime(moment.timestamp)"></div>
                                        <div x-show="moment.location" class="moment-location" x-text="moment.location"></div>
                                    </div>
                                </div>
                                
                                <!-- Content -->
                                <div class="moment-content">
                                    <div x-show="moment.content" class="moment-text" x-text="moment.content"></div>
                                    
                                    <!-- Images Grid -->
                                    <div x-show="moment.images && moment.images.length > 0" class="moment-images" :class="'images-' + moment.images.length">
                                        <template x-for="(image, index) in moment.images" :key="index">
                                            <div class="moment-image">
                                                <img :src="image" :alt="'图片' + (index + 1)" @click="showImage(image)">
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <div class="moment-actions">
                                    <button class="action-button" @click="$store.moments.toggleLike(moment.id)" 
                                            :class="{ liked: $store.moments.isLikedByUser(moment.id) }">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                    <button class="action-button" @click="showCommentInput(moment.id)">
                                        <i class="fas fa-comment"></i>
                                    </button>
                                </div>
                                
                                <!-- Likes and Comments Info -->
                                <div class="moment-stats">
                                    <div x-show="$store.moments.getMomentsLikes(moment.id).length > 0" class="likes-info">
                                        <i class="fas fa-heart"></i>
                                        <span x-text="$store.moments.getMomentsLikes(moment.id).map(l => l.userName).join(', ')"></span>
                                    </div>
                                </div>
                                
                                <!-- Comments -->
                                <div x-show="$store.moments.getMomentsComments(moment.id).length > 0" class="moment-comments">
                                    <template x-for="comment in $store.moments.getMomentsComments(moment.id)" :key="comment.id">
                                        <div class="comment-item">
                                            <span class="comment-user" x-text="comment.userName"></span>
                                            <span x-show="comment.replyTo" class="comment-reply">回复<span x-text="comment.replyTo"></span></span>
                                            <span class="comment-content" x-text="comment.content"></span>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Comment Input -->
                                <div x-show="activeCommentInput === moment.id" class="comment-input-container">
                                    <input type="text" x-model="commentText" 
                                           :placeholder="'评论' + moment.userName + '...'"
                                           @keydown.enter="submitComment(moment.id)"
                                           class="comment-input">
                                    <button @click="submitComment(moment.id)" class="comment-submit">发送</button>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Empty State -->
                        <div x-show="$store.moments.moments.length === 0" class="empty-state">
                            <i class="fas fa-heart-broken"></i>
                            <p>还没有朋友圈动态</p>
                            <button class="button" @click="showCreateMoment()">发布第一条朋友圈</button>
                        </div>
                    </div>
                    
                    <!-- Create Moment Modal -->
                    <div x-show="$store.moments.showCreateModal" class="modal-overlay" @click="hideCreateMoment()">
                        <div class="modal" @click.stop>
                            <div class="modal-header">
                                <button @click="hideCreateMoment()">取消</button>
                                <span>发朋友圈</span>
                                <button @click="publishMoment()" :disabled="!newMomentContent.trim()">发表</button>
                            </div>
                            <div class="modal-content">
                                <textarea x-model="newMomentContent" 
                                         placeholder="这一刻的想法..." 
                                         class="moment-textarea"
                                         rows="6"></textarea>
                                
                                <!-- Local Image Upload -->
                                <div class="image-input-section">
                                    <label>添加图片 (可选)</label>
                                    <div>
                                        <input type="file" 
                                               accept="image/*" 
                                               @change="handleImageUpload($event)"
                                               class="image-file-input"
                                               style="display: none;"
                                               x-ref="imageInput">
                                        <button @click="$refs.imageInput.click()" class="upload-button">
                                            <i class="fas fa-camera"></i> 选择图片
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Preview Images -->
                                <div x-show="newMomentImages.length > 0" class="preview-images">
                                    <template x-for="(image, index) in newMomentImages" :key="index">
                                        <div class="preview-image">
                                            <img :src="image" :alt="'预览' + (index + 1)">
                                            <button @click="removeImage(index)" class="remove-image">×</button>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Location Input -->
                                <div class="location-input-section">
                                    <input type="text" x-model="newMomentLocation" 
                                           placeholder="所在位置 (可选)..." 
                                           class="location-input">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Chat Modal -->
        <div class="modal" :class="{ active: showCreateChatModal }" 
             x-data="{
                 showCreateChatModal: false,
                 selectedPersonaId: '',
                 selectedPersona: null,
                 init() {
                     console.log('Create Chat Modal initialized:', this.showCreateChatModal);
                 }
             }"
             @open-create-chat.window="
                 selectedPersonaId = ''; 
                 selectedPersona = null; 
                 showCreateChatModal = true;
                 console.log('Opening create chat modal');
             ">
            <div class="modal-overlay" @click="showCreateChatModal = false"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>创建私聊</h3>
                    <button class="close-button" @click="showCreateChatModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Empty state when no personas exist -->
                    <div x-show="$store.personas.personas.length === 0" class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div class="empty-state-message">
                            <h4>还没有角色可用</h4>
                            <p>请先创建角色才能开始私聊</p>
                        </div>
                        <button class="button primary" @click="showCreateChatModal = false; $store.app.navigateTo('personas')">
                            前往通讯录创建角色
                        </button>
                    </div>
                    
                    <!-- Normal persona selection when personas exist -->
                    <div x-show="$store.personas.personas.length > 0" class="form-group">
                        <label>选择人设</label>
                        <div class="persona-selector">
                            <template x-for="persona in $store.personas.personas" :key="persona.id">
                                <div class="persona-option" 
                                     :class="{ selected: selectedPersonaId === persona.id }"
                                     @click="selectedPersonaId = persona.id; selectedPersona = persona;">
                                    <div class="persona-avatar">
                                        <img :src="persona.avatar" :alt="persona.name" />
                                    </div>
                                    <div class="persona-name" x-text="persona.name"></div>
                                </div>
                            </template>
                        </div>
                        <div x-show="selectedPersona" class="selected-persona-preview">
                            <strong>选中的人设：</strong>
                            <p x-text="selectedPersona?.persona"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" @click="showCreateChatModal = false">取消</button>
                    <button x-show="$store.personas.personas.length > 0" class="button primary" @click="
                        if (!selectedPersona) { 
                            alert('请选择一个人设'); 
                            return; 
                        }
                        $store.chat.createChat(selectedPersona.name, 'single', selectedPersona.persona, selectedPersona.id, selectedPersona.avatar).then(chatId => {
                            $store.chat.currentMessages = []; // 清空当前消息避免串扰
                            $store.app.navigateTo('chat', { chatId });
                            showCreateChatModal = false;
                        });
                    ">创建</button>
                </div>
            </div>
        </div>

        <!-- Create Group Chat Modal -->
        <div class="modal" :class="{ active: showGroupChatModal }"
             x-data="{
                 showGroupChatModal: false,
                 groupName: '',
                 selectedPersonaIds: [],
                 init() {
                     console.log('Group Chat Modal initialized');
                 },
                 togglePersona(personaId) {
                     const index = this.selectedPersonaIds.indexOf(personaId);
                     if (index > -1) {
                         this.selectedPersonaIds.splice(index, 1);
                     } else {
                         this.selectedPersonaIds.push(personaId);
                     }
                 },
                 isSelected(personaId) {
                     return this.selectedPersonaIds.includes(personaId);
                 },
                 getSelectedPersonas() {
                     return $store.personas.personas.filter(p => this.selectedPersonaIds.includes(p.id));
                 }
             }"
             @open-create-group-chat.window="
                 groupName = '';
                 selectedPersonaIds = [];
                 showGroupChatModal = true;
             ">
            <div class="modal-overlay" @click="showGroupChatModal = false"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>创建群聊</h3>
                    <button class="close-button" @click="showGroupChatModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>群聊名称</label>
                        <input type="text" 
                               x-model="groupName" 
                               placeholder="请输入群聊名称"
                               class="form-input">
                    </div>
                    
                    <!-- Empty state when no personas exist -->
                    <div x-show="$store.personas.personas.length === 0" class="form-group">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="empty-state-message">
                                <h4>还没有角色可用</h4>
                                <p>请先创建至少两个角色才能开始群聊</p>
                            </div>
                            <button class="button primary" @click="showGroupChatModal = false; $store.app.navigateTo('personas')">
                                前往通讯录创建角色
                            </button>
                        </div>
                    </div>
                    
                    <!-- Insufficient personas state when only 1 persona exists -->
                    <div x-show="$store.personas.personas.length === 1" class="form-group">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="empty-state-message">
                                <h4>角色数量不足</h4>
                                <p>群聊需要至少两个角色，请再创建一个角色</p>
                            </div>
                            <button class="button primary" @click="showGroupChatModal = false; $store.app.navigateTo('personas')">
                                前往通讯录创建角色
                            </button>
                        </div>
                    </div>
                    
                    <!-- Normal group member selection when sufficient personas exist -->
                    <div x-show="$store.personas.personas.length >= 2" class="form-group">
                        <label>选择群成员 <span class="text-secondary">(至少选择2个)</span></label>
                        <div class="persona-grid">
                            <template x-for="persona in $store.personas.personas" :key="persona.id">
                                <div class="persona-checkbox-item" 
                                     :class="{ 'selected': isSelected(persona.id) }"
                                     @click="togglePersona(persona.id)">
                                    <div class="persona-checkbox">
                                        <input type="checkbox" 
                                               :checked="isSelected(persona.id)"
                                               @click.stop
                                               @change="togglePersona(persona.id)">
                                    </div>
                                    <div class="persona-mini-avatar">
                                        <img :src="persona.avatar" :alt="persona.name">
                                    </div>
                                    <div class="persona-mini-name" x-text="persona.name"></div>
                                </div>
                            </template>
                        </div>
                        
                        <div x-show="selectedPersonaIds.length > 0" class="selected-members-preview">
                            <strong>已选择 <span x-text="selectedPersonaIds.length"></span> 个成员：</strong>
                            <div class="selected-members-list">
                                <template x-for="persona in getSelectedPersonas()" :key="persona.id">
                                    <span class="member-tag">
                                        <span x-text="persona.name"></span>
                                        <button @click="togglePersona(persona.id)" class="remove-tag">×</button>
                                    </span>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" @click="showGroupChatModal = false">取消</button>
                    <button x-show="$store.personas.personas.length >= 2" class="button primary" 
                            :disabled="!groupName.trim() || selectedPersonaIds.length < 2"
                            @click="
                                if (!groupName.trim()) {
                                    alert('请输入群聊名称');
                                    return;
                                }
                                if (selectedPersonaIds.length < 2) {
                                    alert('请至少选择2个群成员');
                                    return;
                                }
                                const selectedPersonas = getSelectedPersonas();
                                $store.chat.createGroupChat(groupName.trim(), selectedPersonaIds, selectedPersonas).then(chatId => {
                                    if (chatId) {
                                        $store.chat.currentMessages = [];
                                        $store.app.navigateTo('chat', { chatId });
                                        showGroupChatModal = false;
                                    }
                                });
                            ">创建群聊</button>
                </div>
            </div>
        </div>

        <!-- Persona Edit Modal -->
        <div class="modal" :class="{ active: showPersonaModal }" 
             x-data="{ 
                 showPersonaModal: false, 
                 editingPersonaId: null,
                 personaName: '',
                 personaAvatar: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNFNUU1RUEiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzk5OTk5OSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPgo8cGF0aCBkPSJtMjAgMjEtMTYtMTZtMCAwIDMuNSAzLjVNMTcgMTcuNSA2IDciLz4KPHN2Zz4KPC9zdmc+Cjwvc3ZnPgo=',
                 personaText: '',
                 personaMemory: '',
                 init() {
                     console.log('Persona Modal initialized:', this.showPersonaModal);
                 },
                 async handleAvatarUpload(event) {
                     const file = event.target.files[0];
                     if (!file) return;
                     
                     try {
                         const base64 = await window.fileToBase64(file);
                         this.personaAvatar = base64;
                         event.target.value = '';
                     } catch (error) {
                         alert(error.message);
                     }
                 }
             }"
             @open-create-persona.window="
                 editingPersonaId = null;
                 personaName = '';
                 personaAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNFNUU1RUEiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzk5OTk5OSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPgo8cGF0aCBkPSJtMjAgMjEtMTYtMTZtMCAwIDMuNSAzLjVNMTcgMTcuNSA2IDciLz4KPHN2Zz4KPC9zdmc+Cjwvc3ZnPgo=';
                 personaText = '';
                 personaMemory = '';
                 showPersonaModal = true;
             "
             @edit-persona.window="
                 editingPersonaId = $event.detail.id;
                 personaName = $event.detail.name;
                 personaAvatar = $event.detail.avatar;
                 personaText = $event.detail.persona;
                 personaMemory = $event.detail.memory || '';
                 showPersonaModal = true;
             ">
            <div class="modal-overlay" @click="showPersonaModal = false"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 x-text="editingPersonaId ? '编辑人设' : '创建人设'"></h3>
                    <button class="close-button" @click="showPersonaModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>人设名称</label>
                        <input type="text" x-model="personaName" placeholder="请输入人设名称" />
                    </div>
                    <div class="form-group">
                        <label>头像</label>
                        <div class="avatar-upload-section">
                            <div class="avatar-preview">
                                <img :src="personaAvatar" :alt="personaName" class="preview-avatar" />
                            </div>
                            <div class="avatar-upload-controls">
                                <input type="file" 
                                       accept="image/*" 
                                       @change="handleAvatarUpload($event)"
                                       class="avatar-file-input"
                                       style="display: none;"
                                       x-ref="avatarInput">
                                <button @click="$refs.avatarInput.click()" class="upload-button">
                                    <i class="fas fa-camera"></i> 选择头像
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>人设描述</label>
                        <textarea x-model="personaText" rows="6" placeholder="请输入详细的人设描述..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>长期记忆</label>
                        <textarea x-model="personaMemory" rows="6" placeholder="角色的长期记忆，每条记忆一行..."></textarea>
                        <br/>
                        <small style="color: #888; font-size: 12px;">这里的内容会在每次对话时提供给角色，AI也会自动添加新的记忆</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" @click="showPersonaModal = false">取消</button>
                    <button class="button primary" @click="
                        if (!personaName.trim()) {
                            alert('请输入人设名称');
                            return;
                        }
                        if (editingPersonaId) {
                            $store.personas.updatePersona(editingPersonaId, {
                                name: personaName.trim(),
                                avatar: personaAvatar,
                                persona: personaText.trim(),
                                memory: personaMemory.trim()
                            }).then(() => { showPersonaModal = false; });
                        } else {
                            $store.personas.createPersona(
                                personaName.trim(),
                                personaAvatar,
                                personaText.trim(),
                                personaMemory.trim()
                            ).then(() => { showPersonaModal = false; });
                        }
                    " x-text="editingPersonaId ? '保存' : '创建'"></button>
                </div>
            </div>
        </div>
        
        <!-- World Book Modal -->
        <div class="modal" :class="{ active: showWorldBookModal }" 
             x-data="{ 
                 showWorldBookModal: false, 
                 editingWorldBookId: null,
                 worldBookName: '',
                 worldBookContent: ''
             }"
             @open-create-world-book.window="
                 editingWorldBookId = null;
                 worldBookName = '';
                 worldBookContent = '';
                 showWorldBookModal = true;
             "
             @edit-world-book.window="
                 editingWorldBookId = $event.detail.id;
                 worldBookName = $event.detail.name;
                 worldBookContent = $event.detail.content;
                 showWorldBookModal = true;
             ">
            <div class="modal-overlay" @click="showWorldBookModal = false"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 x-text="editingWorldBookId ? '编辑世界书' : '创建世界书'"></h3>
                    <button class="close-button" @click="showWorldBookModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>世界书名称</label>
                        <input type="text" x-model="worldBookName" placeholder="请输入世界书名称" />
                    </div>
                    <div class="form-group">
                        <label>世界书内容</label>
                        <textarea x-model="worldBookContent" 
                                  rows="10" 
                                  placeholder="请输入详细的世界设定内容...支持大量文本和 Emoji 🌟"></textarea>
                        <small class="form-hint">支持数万字的内容，包含 Emoji 等 UTF-8 字符</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" @click="showWorldBookModal = false">取消</button>
                    <button class="button primary" @click="
                        if (!worldBookName.trim()) {
                            alert('请输入世界书名称');
                            return;
                        }
                        if (editingWorldBookId) {
                            $store.worldBook.updateBook(editingWorldBookId, {
                                name: worldBookName.trim(),
                                content: worldBookContent.trim()
                            }).then(() => { 
                                showWorldBookModal = false; 
                                showMessage('世界书保存成功！');
                            });
                        } else {
                            $store.worldBook.createBook(
                                worldBookName.trim(),
                                worldBookContent.trim()
                            ).then(() => { 
                                showWorldBookModal = false; 
                                showMessage('世界书创建成功！');
                            });
                        }
                    " x-text="editingWorldBookId ? '保存' : '创建'"></button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js?v=1.18.0"></script>
    <script src="version-update.js?v=1.18.0"></script>
</body>
</html>