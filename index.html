<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>RuaPhone</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.6.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=1.18.0">
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://unpkg.com/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
</head>
<body>
    <div class="phone-frame" x-data="phoneApp()" x-init="init()">
        <!-- Status Bar -->
        <div class="status-bar">
            <div x-text="currentTime"></div>
            <div class="battery">
                <span x-text="batteryLevel + '%'"></span>
                <div class="battery-icon">
                    <div class="battery-level" :style="`width: ${batteryLevel}%`"></div>
                </div>
            </div>
        </div>

        <!-- Screen Content -->
        <div class="screen">
            <div class="page-container">
                <!-- Home Screen -->
                <div class="page home-screen" :class="{ active: $store.app.currentPage === 'home' }">
                    <div class="clock">
                        <div class="clock-time" x-text="currentTime"></div>
                        <div class="clock-date" x-text="currentDate"></div>
                    </div>
                    
                    <div class="app-grid">
                        <div class="app-icon" @click="navigateTo('chat-list')">
                            <div class="app-icon-image">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="app-icon-label">ËÅäÂ§©</div>
                        </div>

                        <div class="app-icon" @click="navigateTo('moments')" data-testid="moments-icon">
                            <div class="app-icon-image">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="app-icon-label">ÊúãÂèãÂúà</div>
                        </div>

                        <!-- <div class="app-icon" @click="navigateTo('settings')">
                            <div class="app-icon-image">
                                <i class="fas fa-palette"></i>
                            </div>
                            <div class="app-icon-label">‰∏ªÈ¢ò</div>
                        </div> -->
                        
                        <div class="app-icon" @click="navigateTo('world-book')">
                            <div class="app-icon-image">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="app-icon-label">‰∏ñÁïå‰π¶</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('personas')">
                            <div class="app-icon-image">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <div class="app-icon-label">ÈÄöËÆØÂΩï</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('profile')">
                            <div class="app-icon-image">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="app-icon-label">‰∏™‰∫∫ËµÑÊñô</div>
                        </div>
                        
                        <div class="app-icon" @click="navigateTo('api-settings')">
                            <div class="app-icon-image">
                                <i class="fas fa-key"></i>
                            </div>
                            <div class="app-icon-label">APIËÆæÁΩÆ</div>
                        </div>
                        
                        
                    </div>
                    
                    <!-- Version info -->
                    <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: #999; font-size: 10px; text-align: center;">
                        RuaPhone v1.18.0
                    </div>
                </div>

                <!-- Chat List Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'chat-list' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">ËÅäÂ§©</div>
                        <div class="header-actions">
                            <button class="header-button" @click="$dispatch('open-create-chat')" title="ÁßÅËÅä">
                                <i class="fas fa-user"></i>
                            </button>
                            <button class="header-button" @click="$dispatch('open-create-group-chat')" title="Áæ§ËÅä">
                                <i class="fas fa-users"></i>
                            </button>
                        </div>
                    </div>
                    <div class="content">
                        <div class="list-container" x-show="$store.chat.chats.length > 0">
                            <template x-for="chat in $store.chat.chats" :key="chat.id">
                                <div class="swipe-container" 
                                     x-data="{
                                         startX: 0,
                                         currentX: 0,
                                         isDragging: false,
                                         isOpen: false,
                                         threshold: 80,
                                         
                                         get swipeStyle() {
                                             const translateX = this.isOpen ? -80 : Math.max(-80, Math.min(0, this.currentX - this.startX));
                                             return `transform: translateX(${translateX}px); transition: ${this.isDragging ? 'none' : 'transform 0.3s ease'};`;
                                         },
                                         
                                         handleTouchStart(e) {
                                             this.startX = e.touches[0].clientX;
                                             this.currentX = e.touches[0].clientX;
                                             this.isDragging = true;
                                         },
                                         
                                         handleTouchMove(e) {
                                             if (!this.isDragging) return;
                                             this.currentX = e.touches[0].clientX;
                                             e.preventDefault(); // Èò≤Ê≠¢È°µÈù¢ÊªöÂä®
                                         },
                                         
                                         handleTouchEnd(e) {
                                             if (!this.isDragging) return;
                                             this.isDragging = false;
                                             const diff = this.startX - this.currentX;
                                             
                                             if (diff > this.threshold) {
                                                 this.isOpen = true;
                                             } else {
                                                 this.isOpen = false;
                                             }
                                         },
                                         
                                         handleMouseDown(e) {
                                             this.startX = e.clientX;
                                             this.currentX = e.clientX;
                                             this.isDragging = true;
                                             e.preventDefault();
                                         },
                                         
                                         handleMouseMove(e) {
                                             if (!this.isDragging) return;
                                             this.currentX = e.clientX;
                                         },
                                         
                                         handleMouseUp(e) {
                                             if (!this.isDragging) return;
                                             this.isDragging = false;
                                             const diff = this.startX - this.currentX;
                                             
                                             if (diff > this.threshold) {
                                                 this.isOpen = true;
                                             } else {
                                                 this.isOpen = false;
                                             }
                                         },
                                         
                                         handleClick(e) {
                                             if (this.isOpen) {
                                                 e.stopPropagation();
                                                 this.isOpen = false;
                                             } else {
                                                 openChat(chat.id);
                                             }
                                         },
                                         
                                         deleteChat() {
                                             $store.chat.deleteChat(chat.id);
                                         }
                                     }">
                                    <div class="swipe-content" 
                                         :style="swipeStyle"
                                         @touchstart="handleTouchStart"
                                         @touchmove="handleTouchMove"
                                         @touchend="handleTouchEnd"
                                         @mousedown="handleMouseDown"
                                         @mousemove="handleMouseMove"
                                         @mouseup="handleMouseUp"
                                         @mouseleave="handleMouseUp"
                                         @click="handleClick">
                                        <div class="list-item">
                                            <div class="list-item-avatar-container"
                                                 x-data="{
                                                     getChatAvatar() {
                                                         // For single chat, get dynamic avatar from persona
                                                         if (chat.type !== 'group' && chat.personaId) {
                                                             const persona = $store.personas.personas.find(p => p.id === chat.personaId);
                                                             if (persona?.avatar) {
                                                                 return persona.avatar;
                                                             }
                                                         }
                                                         // Fallback to chat avatar or placeholder
                                                         return chat.avatar || 'https://via.placeholder.com/40';
                                                     }
                                                 }">
                                                <img x-show="getChatAvatar() && getChatAvatar() !== 'https://via.placeholder.com/40'" 
                                                     :src="getChatAvatar()" 
                                                     :alt="chat.name"
                                                     class="list-item-avatar">
                                                <div x-show="chat.type === 'group'" class="group-indicator">
                                                    <i class="fas fa-users"></i>
                                                </div>
                                            </div>
                                            <div class="list-item-content">
                                                <div class="list-item-title">
                                                    <span x-text="chat.name"></span>
                                                    <span x-show="chat.type === 'group' && chat.personaIds" 
                                                          class="chat-member-count"
                                                          x-text="`(${chat.personaIds?.length || 0})`"></span>
                                                </div>
                                                <div class="list-item-subtitle" x-text="chat.lastMessage || 'ÊöÇÊó†Ê∂àÊÅØ'"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="swipe-actions">
                                        <button class="delete-btn" @click="deleteChat()">
                                            <i class="fas fa-trash"></i>
                                            Âà†Èô§
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="$store.chat.chats.length === 0" class="text-center p-4">
                            <p class="text-secondary">ÊöÇÊó†ËÅäÂ§©ËÆ∞ÂΩï</p>
                            <div class="button-group mt-4">
                                <button class="button" @click="$dispatch('open-create-chat')">ÂàõÂª∫ÁßÅËÅä</button>
                                <button class="button" @click="$dispatch('open-create-group-chat')">ÂàõÂª∫Áæ§ËÅä</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Interface Page -->
                <div class="page chat-page" :class="{ active: $store.app.currentPage === 'chat' }" x-data="chatInterface()">
                    <div class="header">
                        <button class="header-button" @click="$store.app.navigateTo('chat-list')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">
                            <span x-text="$store.app.isLoading ? 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...' : (currentChat?.name || 'ËÅäÂ§©')"></span>
                            <span x-show="currentChat?.type === 'group' && currentChat?.personaIds" 
                                  class="group-member-count"
                                  x-text="`(${currentChat?.personaIds?.length || 0}‰∫∫)`"></span>
                        </div>
                        <div style="width: 32px;"></div>
                    </div>
                    
                    <!-- Messages Container -->
                    <div class="chat-messages" x-ref="messagesContainer">
                        <template x-for="message in messages" :key="message.id">
                            <div class="message-wrapper" :class="{ 'user': message.role === 'user', 'ai': message.role === 'assistant' }">
                                
                                <!-- Recall Message (system message style) -->
                                <template x-if="message.type === 'recall'">
                                    <div class="message-recall">
                                        <span x-text="(message.senderName || (message.role === 'user' ? '‰Ω†' : 'ÂØπÊñπ')) + 'Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ'"></span>
                                    </div>
                                </template>
                                
                                <!-- Regular Messages -->
                                <template x-if="message.type !== 'recall'">
                                    <div class="message message-bubble" 
                                         :class="{ 
                                             'user': message.role === 'user', 
                                             'assistant': message.role === 'assistant',
                                             'ai': message.role === 'assistant',
                                             'message-text': message.type === 'text' || !message.type,
                                             'message-voice': message.type === 'voice',
                                             'message-image': message.type === 'image',
                                             'message-transfer': message.type === 'transfer',
                                             'message-sticker': message.type === 'sticker',
                                             'message-html': message.type === 'html'
                                         }">
                                        
                                        <!-- Avatar -->
                                        <div class="avatar avatar-group">
                                            <div x-show="message.role === 'user'" class="user-avatar">
                                                <img x-show="$store.profile.profile.avatar" 
                                                     :src="$store.profile.profile.avatar" 
                                                     alt="ÊàëÁöÑÂ§¥ÂÉè"
                                                     class="user-avatar-img"
                                                     @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='inline';">
                                                <span x-show="!$store.profile.profile.avatar">üë§</span>
                                            </div>
                                            <div x-show="message.role === 'assistant'" class="ai-avatar"
                                                 x-data="{
                                                     getGroupMemberAvatar() {
                                                         if (currentChat?.type === 'group' && message.senderName) {
                                                             // Dynamically get avatar from personas store
                                                             const persona = $store.personas.personas.find(p => p.name === message.senderName);
                                                             return persona?.avatar || 'https://via.placeholder.com/40';
                                                         }
                                                         // For single chat, dynamically get avatar from persona
                                                         if (currentChat?.personaId) {
                                                             const persona = $store.personas.personas.find(p => p.id === currentChat.personaId);
                                                             if (persona?.avatar) {
                                                                 return persona.avatar;
                                                             }
                                                         }
                                                         // Fallback to chat avatar or placeholder
                                                         return currentChat?.avatar || 'https://via.placeholder.com/40';
                                                     }
                                                 }">
                                                <img x-show="getGroupMemberAvatar() && getGroupMemberAvatar() !== 'https://via.placeholder.com/40'" 
                                                     :src="getGroupMemberAvatar()" 
                                                     :alt="message.senderName || currentChat?.name"
                                                     @error="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='inline';">
                                                <span x-show="!getGroupMemberAvatar() || getGroupMemberAvatar() === 'https://via.placeholder.com/40'">ü§ñ</span>
                                            </div>
                                        </div>

                                        <!-- Message Content -->
                                        <div class="message-content content" 
                                             :class="{ 'no-bubble': message.type === 'voice' || message.type === 'image' || message.type === 'transfer' || message.type === 'sticker' || message.type === 'html' }"
                                             @pointerdown="$store.messageTooltip.startLongPress($event, $el, message.id)"
                                             @pointerup="$store.messageTooltip.endLongPress()"
                                             @pointercancel="$store.messageTooltip.cancelLongPress()"
                                             @pointerleave="$store.messageTooltip.cancelLongPress()"
                                             @pointermove="$store.messageTooltip.moveLongPress($event)"
                                             @contextmenu.prevent="$store.messageTooltip.showForMessage($el, message.id)"
                                             style="user-select: none; -webkit-touch-callout: none; touch-action: manipulation;">
                                            
                                            <!-- Text Message -->
                                            <template x-if="message.type === 'text' || !message.type">
                                                <div class="message-text-content" x-data="{ 
                                                    parseQuote(content) {
                                                        const quoteMatch = content?.match(/^quote<([^>]*)>(.*)/s);
                                                        if (quoteMatch) {
                                                            return {
                                                                quoted: quoteMatch[1],
                                                                text: quoteMatch[2]
                                                            };
                                                        }
                                                        return null;
                                                    },
                                                    get parsedContent() {
                                                        const msgContent = message.content || 'Ê∂àÊÅØÂÜÖÂÆπ‰∏∫Á©∫';
                                                        return this.parseQuote(msgContent);
                                                    },
                                                    get isEditing() {
                                                        return $store.chat.editingMessageId === message.id;
                                                    }
                                                }">
                                                    <!-- Edit mode -->
                                                    <div x-show="isEditing" class="message-edit-mode">
                                                        <textarea 
                                                            x-model="$store.chat.editingContent"
                                                            @keydown.escape="$store.chat.cancelEdit()"
                                                            @keydown.enter.ctrl="$store.chat.saveEdit()"
                                                            @keydown.enter.meta="$store.chat.saveEdit()"
                                                            class="message-edit-input"
                                                            :placeholder="message.content"
                                                            x-init="$el.focus(); $el.setSelectionRange($el.value.length, $el.value.length)"
                                                            rows="2"></textarea>
                                                        <button @click="$store.chat.saveEdit()" class="message-edit-save" title="‰øùÂ≠ò">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    </div>
                                                    
                                                    <!-- Normal display mode -->
                                                    <div x-show="!isEditing">
                                                        <!-- Group chat sender name -->
                                                        <div x-show="message.senderName" class="group-sender-name" x-text="message.senderName"></div>
                                                        
                                                        <!-- Message with quote -->
                                                        <div x-show="parsedContent">
                                                            <div class="quoted-content">
                                                                <div class="quote-bar"></div>
                                                                <div class="quote-text" x-text="parsedContent?.quoted"></div>
                                                            </div>
                                                            <div class="message-text" x-text="parsedContent?.text"></div>
                                                        </div>
                                                        <!-- Regular message without quote -->
                                                        <div x-show="!parsedContent" class="message-text" x-text="message.content || 'Ê∂àÊÅØÂÜÖÂÆπ‰∏∫Á©∫'"></div>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Voice Message -->
                                            <template x-if="message.type === 'voice'">
                                                <div class="voice-message" @click="playVoiceMessage(message)">
                                                    <div class="voice-icon">üé§</div>
                                                    <div class="voice-waveform">
                                                        <span></span><span></span><span></span><span></span><span></span>
                                                    </div>
                                                    <div class="voice-duration" x-text="(message.voiceDuration || 1) + '‚Ä≥'"></div>
                                                </div>
                                            </template>
                                            
                                            <!-- Image Message -->
                                            <template x-if="message.type === 'image'">
                                                <div class="image-message">
                                                    <img :src="message.imageUrl" 
                                                         :alt="message.content || 'ÂõæÁâá'"
                                                         @click="viewImage(message.imageUrl)"
                                                         @error="$event.target.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+5Zu+54mH5LiN5a2Y5ZyoPC90ZXh0Pjwvc3ZnPg=='; $event.target.style.maxWidth='200px'; $event.target.style.maxHeight='100px';">
                                                </div>
                                            </template>
                                            
                                            <!-- Transfer Message -->
                                            <template x-if="message.type === 'transfer'">
                                                <div class="transfer-message">
                                                    <div class="transfer-icon">üí∞</div>
                                                    <div class="transfer-content">
                                                        <div class="transfer-title" x-text="message.role === 'user' ? 'ËΩ¨Ë¥¶ÁªôÂØπÊñπ' : 'Êî∂Âà∞ËΩ¨Ë¥¶'"></div>
                                                        <div class="transfer-amount">¬•<span x-text="(message.transferAmount || 0).toFixed(2)"></span></div>
                                                        <div class="transfer-note" x-text="message.transferNote || (message.role === 'user' ? 'ËΩ¨Ë¥¶Áªô‰Ω†' : 'ÂØπÊñπËΩ¨Ë¥¶Áªô‰Ω†')"></div>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Sticker Message -->
                                            <template x-if="message.type === 'sticker'">
                                                <div class="sticker-message">
                                                    <img :src="message.stickerUrl" 
                                                         :alt="message.content || 'Ë°®ÊÉÖ'"
                                                         @error="$event.target.style.display='none'">
                                                </div>
                                            </template>
                                            
                                            <!-- HTML Message -->
                                            <template x-if="message.type === 'html'">
                                                <div class="html-message" x-data="{
                                                    iframeId: 'html-msg-' + message.id,
                                                    scale: 1,
                                                    originalSize: false,
                                                    autoResize() {
                                                        const iframe = document.getElementById(this.iframeId);
                                                        const container = iframe?.parentElement;
                                                        if (iframe && iframe.contentWindow && container) {
                                                            try {
                                                                const body = iframe.contentWindow.document.body;
                                                                const html = iframe.contentWindow.document.documentElement;
                                                                
                                                                // Ëé∑ÂèñÂÜÖÂÆπÂÆûÈôÖÂ∞∫ÂØ∏
                                                                const contentHeight = Math.max(
                                                                    body.scrollHeight, body.offsetHeight,
                                                                    html.scrollHeight, html.offsetHeight
                                                                );
                                                                const contentWidth = Math.max(
                                                                    body.scrollWidth, body.offsetWidth,
                                                                    html.scrollWidth, html.offsetWidth
                                                                );
                                                                
                                                                // ËÆæÁΩÆiframeÂéüÂßãÂ∞∫ÂØ∏
                                                                iframe.style.width = contentWidth + 'px';
                                                                iframe.style.height = contentHeight + 'px';
                                                                
                                                                // Ëé∑ÂèñÂÆπÂô®ÊúÄÂ§ßÂ∞∫ÂØ∏
                                                                const maxWidth = 320;
                                                                const maxHeight = 450;
                                                                
                                                                // ËÆ°ÁÆóÁº©ÊîæÊØî‰æã
                                                                if (contentWidth > maxWidth || contentHeight > maxHeight) {
                                                                    const scaleX = maxWidth / contentWidth;
                                                                    const scaleY = maxHeight / contentHeight;
                                                                    this.scale = Math.min(scaleX, scaleY);
                                                                    
                                                                    // Â∫îÁî®Áº©Êîæ
                                                                    iframe.style.transform = `scale(${this.scale})`;
                                                                    iframe.style.transformOrigin = 'top left';
                                                                    
                                                                    // Ë∞ÉÊï¥ÂÆπÂô®È´òÂ∫¶‰ª•ÈÄÇÂ∫îÁº©ÊîæÂêéÁöÑÂÜÖÂÆπ
                                                                    container.style.height = (contentHeight * this.scale) + 'px';
                                                                    container.style.width = (contentWidth * this.scale) + 'px';
                                                                } else {
                                                                    this.scale = 1;
                                                                    iframe.style.transform = 'none';
                                                                    container.style.height = contentHeight + 'px';
                                                                    container.style.width = contentWidth + 'px';
                                                                }
                                                            } catch(e) {
                                                                console.log('Cannot resize iframe:', e);
                                                            }
                                                        }
                                                    },
                                                    toggleSize() {
                                                        const iframe = document.getElementById(this.iframeId);
                                                        const container = iframe?.parentElement;
                                                        if (!iframe || !container) return;
                                                        
                                                        this.originalSize = !this.originalSize;
                                                        if (this.originalSize) {
                                                            // ÊòæÁ§∫ÂéüÂßãÂ∞∫ÂØ∏
                                                            iframe.style.transform = 'none';
                                                            container.style.overflow = 'auto';
                                                            container.style.maxWidth = '100%';
                                                            container.style.maxHeight = '80vh';
                                                        } else {
                                                            // ÊÅ¢Â§çÁº©Êîæ
                                                            this.autoResize();
                                                            container.style.overflow = 'hidden';
                                                        }
                                                    }
                                                }" @dblclick="toggleSize()">
                                                    <iframe 
                                                        :id="iframeId"
                                                        :srcdoc="message.content"
                                                        sandbox="allow-scripts allow-forms allow-modals allow-same-origin"
                                                        scrolling="no"
                                                        frameborder="0"
                                                        @load="autoResize()"
                                                        style="min-height: 100px; border-radius: 12px; background: white;">
                                                    </iframe>
                                                    <div x-show="scale < 1 && !originalSize" class="scale-indicator">
                                                        <i class="fas fa-search-minus"></i> 
                                                        <span x-text="Math.round(scale * 100) + '%'"></span>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Message Time -->
                                            <div class="message-time" x-text="formatTime(message.timestamp)"></div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        
                    </div>
                    
                    <!-- Message Tooltip -->
                    <template x-if="$store.messageTooltip.show">
                        <div>
                            <!-- Backdrop -->
                            <div class="message-tooltip-backdrop" 
                                 @click="$store.messageTooltip.hide()"
                                 @wheel="$store.messageTooltip.hide()"></div>
                            
                            <!-- Tooltip Card -->
                            <div class="message-tooltip-menu" 
                                 :class="$store.messageTooltip.placement"
                                 role="menu" 
                                 aria-label="Ê∂àÊÅØËèúÂçï"
                                 :style="`left: ${$store.messageTooltip.x}px; top: ${$store.messageTooltip.y}px;`"
                                 @keydown.escape.window="$store.messageTooltip.hide()">
                                <div class="message-tooltip-card">
                                    <button role="menuitem" @click="$store.messageTooltip.quoteMessage()">
                                        <i class="fas fa-quote-left"></i>
                                        <span>ÂºïÁî®</span>
                                    </button>
                                    <button role="menuitem" @click="$store.messageTooltip.editMessage()">
                                        <i class="fas fa-edit"></i>
                                        <span>ÁºñËæë</span>
                                    </button>
                                    <button role="menuitem" @click="$store.messageTooltip.deleteMessage()">
                                        <i class="fas fa-trash"></i>
                                        <span>Âà†Èô§</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Input Area -->
                    <div class="chat-input" 
                         x-data="{
                             showVoiceInput: false, 
                             showTransferDialog: false, 
                             voiceText: '', 
                             transferAmount: '', 
                             transferNote: '',
                             showImageInput: false,
                             
                             async sendVoiceMessage() {
                                 const chatId = Alpine.store('app').currentChatId;
                                 
                                 if (!this.voiceText.trim()) return;
                                 
                                 const voiceMessage = {
                                     type: 'voice',
                                     content: this.voiceText.trim(),
                                     voiceDuration: Math.ceil(this.voiceText.length / 5)
                                 };
                                 
                                 await Alpine.store('chat').sendMessage(chatId, voiceMessage);
                                 
                                 // Reset and close modal
                                 this.voiceText = '';
                                 this.showVoiceInput = false;
                                 
                                 // Scroll to bottom
                                 this.$nextTick(() => {
                                     const container = this.$el.closest('.chat-page').querySelector('[x-ref=messagesContainer]');
                                     if (container) {
                                         container.scrollTop = container.scrollHeight;
                                     }
                                 });
                             },
                             
                             async sendTransferMessage() {
                                 const chatId = Alpine.store('app').currentChatId;
                                 
                                 const amount = parseFloat(this.transferAmount);
                                 const note = this.transferNote.trim();
                                 
                                 if (isNaN(amount) || amount <= 0 || amount > 9999) {
                                     alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ù (0-9999)');
                                     return;
                                 }
                                 
                                 const transferMessage = {
                                     type: 'transfer',
                                     transferAmount: amount,
                                     transferNote: note || 'ËΩ¨Ë¥¶Áªô‰Ω†',
                                     content: `[ËΩ¨Ë¥¶] ¬•${amount.toFixed(2)}`
                                 };
                                 
                                 await Alpine.store('chat').sendMessage(chatId, transferMessage);
                                 
                                 // Reset inputs and close modal
                                 this.transferAmount = '';
                                 this.transferNote = '';
                                 this.showTransferDialog = false;
                                 
                                 // Scroll to bottom
                                 this.$nextTick(() => {
                                     const container = this.$el.closest('.chat-page').querySelector('[x-ref=messagesContainer]');
                                     if (container) {
                                         container.scrollTop = container.scrollHeight;
                                     }
                                 });
                             },
                             
                             async handleImageSelect(event) {
                                 const file = event.target.files[0];
                                 if (!file) return;
                                 
                                 try {
                                     const base64 = await window.fileToBase64(file);
                                     const chatId = Alpine.store('app').currentChatId;
                                     
                                     const imageMessage = {
                                         type: 'image',
                                         imageUrl: base64,
                                         content: `[ÂõæÁâá] ${file.name}`
                                     };
                                     
                                     await Alpine.store('chat').sendMessage(chatId, imageMessage);
                                     
                                     // Clear file input
                                     event.target.value = '';
                                     
                                     // Scroll to bottom
                                     this.$nextTick(() => {
                                         const container = this.$el.closest('.chat-page').querySelector('[x-ref=messagesContainer]');
                                         if (container) {
                                             container.scrollTop = container.scrollHeight;
                                         }
                                     });
                                     
                                 } catch (error) {
                                     console.error('Image upload error:', error);
                                     alert('ÂõæÁâá‰∏ä‰º†Â§±Ë¥•: ' + error.message);
                                 }
                             }
                         }">
                        
                        <!-- Input Toolbar -->
                        <div class="input-toolbar">
                            <button @click="showVoiceInput = true" class="toolbar-button" title="ËØ≠Èü≥Ê∂àÊÅØ">
                                <i class="ri-mic-line"></i>
                            </button>
                            <button @click="$refs.imageInput.click()" class="toolbar-button" title="ÂõæÁâá">
                                <i class="ri-image-line"></i>
                            </button>
                            <button @click="showTransferDialog = true" class="toolbar-button" title="ËΩ¨Ë¥¶">
                                <i class="ri-money-cny-box-line"></i>
                            </button>
                        </div>
                        
                        <!-- Quoted Message Display -->
                        <div x-show="$store.chat.quotedMessage" 
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 transform translate-y-full"
                             x-transition:enter-end="opacity-100 transform translate-y-0"
                             x-transition:leave="transition ease-in duration-150"
                             x-transition:leave-start="opacity-100 transform translate-y-0"
                             x-transition:leave-end="opacity-0 transform translate-y-full"
                             class="quoted-message-bar">
                            <div class="quoted-message-content">
                                <div class="quoted-message-indicator">
                                    <i class="fas fa-reply"></i>
                                    <span>ÂõûÂ§ç</span>
                                    <span class="quoted-name" x-text="$store.chat.quotedMessage?.role === 'user' ? 'Êàë' : 'AI'"></span>
                                </div>
                                <div class="quoted-text" x-text="$store.chat.quotedMessage?.content?.substring(0, 50) + ($store.chat.quotedMessage?.content?.length > 50 ? '...' : '')"></div>
                            </div>
                            <button class="quoted-message-close" @click="$store.chat.quotedMessage = null">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Main Input Container -->
                        <div class="chat-input-wrapper">
                            <div class="input-container">
                                <input 
                                    type="text" 
                                    x-model="newMessage" 
                                    @keydown.enter="sendMessage()"
                                    placeholder="ËæìÂÖ•Ê∂àÊÅØ..."
                                    class="message-input"
                                >
                            </div>
                            <div class="button-group">
                                <button @click="triggerAIResponse()" class="ai-button" :disabled="!hasUserMessages()">
                                    <i class="ri-chat-ai-line"></i>
                                </button>
                                <button @click="sendMessage()" class="send-button" :disabled="!newMessage.trim()">
                                    <i class="ri-send-plane-fill"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Voice Input Modal -->
                        <div x-show="showVoiceInput" 
                             x-transition
                             class="input-modal"
                             @click.away="showVoiceInput = false">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>ÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØ</h3>
                                    <button @click="showVoiceInput = false" class="close-button">‚úï</button>
                                </div>
                                <textarea 
                                    x-model="voiceText" 
                                    placeholder="ËæìÂÖ•ËØ≠Èü≥Ê∂àÊÅØÂÜÖÂÆπ..."
                                    class="voice-textarea"
                                    rows="3"></textarea>
                                <div class="modal-buttons">
                                    <button @click="showVoiceInput = false" class="cancel-button">ÂèñÊ∂à</button>
                                    <button @click="sendVoiceMessage()" class="confirm-button">ÂèëÈÄÅ</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transfer Dialog -->
                        <div x-show="showTransferDialog" 
                             x-transition
                             class="input-modal"
                             @click.away="showTransferDialog = false">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>ÂèëÈÄÅËΩ¨Ë¥¶</h3>
                                    <button @click="showTransferDialog = false" class="close-button">‚úï</button>
                                </div>
                                <div class="transfer-form">
                                    <div class="form-group">
                                        <label>ËΩ¨Ë¥¶ÈáëÈ¢ù</label>
                                        <input type="number" 
                                               x-model="transferAmount" 
                                               placeholder="0.00" 
                                               min="0" 
                                               max="9999"
                                               step="0.01"
                                               class="transfer-input">
                                    </div>
                                    <div class="form-group">
                                        <label>ËΩ¨Ë¥¶Â§áÊ≥®</label>
                                        <input type="text" 
                                               x-model="transferNote" 
                                               placeholder="ËΩ¨Ë¥¶Áªô‰Ω†"
                                               class="transfer-input">
                                    </div>
                                </div>
                                <div class="modal-buttons">
                                    <button @click="showTransferDialog = false" class="cancel-button">ÂèñÊ∂à</button>
                                    <button @click="sendTransferMessage()" class="confirm-button">Á°ÆËÆ§ËΩ¨Ë¥¶</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Image Input -->
                        <input type="file" 
                               accept="image/*" 
                               @change="handleImageSelect($event)"
                               x-ref="imageInput" 
                               style="display: none;">
                    </div>
                </div>

                <!-- Profile Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'profile' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">‰∏™‰∫∫ËµÑÊñô</div>
                        <button class="header-button profile-save-btn" @click="saveProfile()" :disabled="profileSaving">
                            <template x-if="!profileSaving">
                                <span>‰øùÂ≠ò</span>
                            </template>
                            <template x-if="profileSaving">
                                <i class="fas fa-spinner fa-spin"></i>
                            </template>
                        </button>
                    </div>
                    <div class="content profile-content">
                        <!-- Avatar Section -->
                        <div class="profile-avatar-section">
                            <div class="profile-avatar-container" @click="$refs.avatarInput.click()">
                                <img x-show="$store.profile.profile.avatar" 
                                     :src="$store.profile.profile.avatar" 
                                     alt="Â§¥ÂÉè"
                                     class="profile-avatar">
                                <div x-show="!$store.profile.profile.avatar" class="profile-avatar-placeholder">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="profile-avatar-overlay">
                                    <i class="fas fa-camera"></i>
                                </div>
                            </div>
                            <input type="file" 
                                   x-ref="avatarInput" 
                                   @change="handleAvatarUpload($event)" 
                                   accept="image/*" 
                                   style="display: none;">
                        </div>
                        
                        <!-- Profile Form -->
                        <div class="profile-form">
                            <div class="form-group">
                                <label class="form-label">ÂßìÂêç</label>
                                <input type="text" 
                                       class="form-input" 
                                       x-model="$store.profile.profile.name" 
                                       placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂßìÂêç">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ÊÄßÂà´</label>
                                <input type="text" 
                                       class="form-input" 
                                       x-model="$store.profile.profile.gender" 
                                       placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊÄßÂà´">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Âπ¥ÈæÑ</label>
                                <input type="number" 
                                       class="form-input" 
                                       x-model="$store.profile.profile.age" 
                                       placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂπ¥ÈæÑ"
                                       min="1" 
                                       max="150">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">‰∏™‰∫∫‰ªãÁªç</label>
                                <textarea class="form-input profile-bio" 
                                          x-model="$store.profile.profile.bio" 
                                          placeholder="‰ªãÁªç‰∏Ä‰∏ãËá™Â∑±Âêß..."
                                          rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Settings Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'api-settings' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">APIËÆæÁΩÆ</div>
                        <div style="width: 32px;"></div>
                    </div>
                    <div class="content">
                        <!-- Version Display -->
                        <div class="version-info" style="
                            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
                            color: white;
                            padding: 12px 16px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            text-align: center;
                            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
                        ">
                            <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">
                                üöÄ RuaPhone v1.18.0
                            </div>
                            <div style="font-size: 12px; opacity: 0.9;">
                                ÂèØÁà±ÁöÑÂ∞èÊâãÊú∫rua~
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">APIÁ±ªÂûã</label>
                            <select class="form-input" x-model="$store.settings.apiConfig.apiType" 
                                @change="$store.settings.updateApiType($event.target.value)">
                                <option value="openai">OpenAI ÔºàapiÁ´ôÈÄâËøô‰∏™Ôºâ</option>
                                <option value="gemini">Google Gemini</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">APIÂú∞ÂùÄ</label>
                            <input type="text" class="form-input" x-model="$store.settings.apiConfig.baseURL" 
                                :placeholder="$store.settings.apiConfig.apiType === 'gemini' ? 'Ëá™Âä®‰ΩøÁî® Google ÂÆòÊñπ API' : 'https://api.openai.com'"
                                :disabled="$store.settings.apiConfig.apiType === 'gemini'">
                            <small class="form-help" x-show="$store.settings.apiConfig.apiType !== 'gemini'">
                                ÁªìÂ∞æÊúâÊ≤°Êúâ/v1ÈÉΩÂèØ‰ª•
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">APIÂØÜÈí•</label>
                            <input type="password" class="form-input" x-model="$store.settings.apiConfig.apiKey" 
                                :placeholder="$store.settings.apiConfig.apiType === 'gemini' ? 'AIza...' : 'sk-...'">
                            <small class="form-help">ÊîØÊåÅÂ§ö‰∏™ÂØÜÈí•ÔºåÁî®ÈÄóÂè∑ÂàÜÈöî</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ê®°Âûã</label>
                            
                            <!-- Gemini Models (Dynamic) -->
                            <template x-if="$store.settings.apiConfig.apiType === 'gemini'">
                                <div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select class="form-input" x-model="$store.settings.apiConfig.model" style="flex: 1;">
                                            <option value="" disabled>
                                                <span x-show="$store.settings.modelsLoading">Ê≠£Âú®Âä†ËΩΩÊ®°Âûã...</span>
                                                <span x-show="!$store.settings.modelsLoading && $store.settings.availableModels.length === 0">ËØ∑ÂÖàÈÖçÁΩÆ Gemini API ÂØÜÈí•</span>
                                            </option>
                                            <template x-for="model in $store.settings.availableModels" :key="model.id">
                                                <option :value="model.id" x-text="model.name || model.id"></option>
                                            </template>
                                        </select>
                                        <button type="button" 
                                            class="button" 
                                            style="padding: 8px 12px; font-size: 14px; background: #007AFF;" 
                                            @click="$store.settings.refreshModels()"
                                            :disabled="$store.settings.modelsLoading"
                                            :class="{ 'opacity-50 cursor-not-allowed': $store.settings.modelsLoading }">
                                            ÊãâÂèñ
                                        </button>
                                    </div>
                                    
                                    <!-- Loading indicator -->
                                    <div x-show="$store.settings.modelsLoading" 
                                        class="form-help" 
                                        style="color: #007AFF; margin-top: 8px;">
                                        <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                                        Ê≠£Âú®‰ªé Gemini API Ëé∑ÂèñÊ®°ÂûãÂàóË°®...
                                    </div>
                                    
                                    <!-- Error message -->
                                    <div x-show="$store.settings.modelsError" 
                                        class="form-help" 
                                        style="color: #FF3B30; margin-top: 8px;">
                                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                                        <span x-text="$store.settings.modelsError"></span>
                                    </div>
                                    
                                    <!-- Success message -->
                                    <div x-show="!$store.settings.modelsError && !$store.settings.modelsLoading && $store.settings.availableModels.length > 0" 
                                        class="form-help" 
                                        style="color: #34C759; margin-top: 8px;">
                                        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                                        Â∑≤Ëé∑Âèñ <span x-text="$store.settings.availableModels.length"></span> ‰∏™ Gemini Ê®°Âûã
                                    </div>
                                </div>
                            </template>
                            
                            <!-- OpenAI-compatible Models -->
                            <template x-if="$store.settings.apiConfig.apiType !== 'gemini'">
                                <div>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <select class="form-input" x-model="$store.settings.apiConfig.model" style="flex: 1;">
                                            <option value="" disabled>
                                                <span x-show="$store.settings.modelsLoading">Ê≠£Âú®Âä†ËΩΩÊ®°Âûã...</span>
                                                <span x-show="!$store.settings.modelsLoading && $store.settings.availableModels.length === 0">ËØ∑ÂÖàÈÖçÁΩÆAPIÂú∞ÂùÄÂíåÂØÜÈí•</span>
                                            </option>
                                            <template x-for="model in $store.settings.availableModels" :key="model.id">
                                                <option :value="model.id" x-text="model.id"></option>
                                            </template>
                                        </select>
                                        <button type="button" 
                                            class="button" 
                                            style="padding: 8px 12px; font-size: 14px; background: #007AFF;" 
                                            @click="$store.settings.refreshModels()"
                                            :disabled="$store.settings.modelsLoading"
                                            :class="{ 'opacity-50 cursor-not-allowed': $store.settings.modelsLoading }">
                                            ÊãâÂèñ
                                        </button>
                                    </div>
                                    
                                    <!-- Loading indicator -->
                                    <div x-show="$store.settings.modelsLoading" 
                                        class="form-help" 
                                        style="color: #007AFF; margin-top: 8px;">
                                        <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                                        Ê≠£Âú®‰ªé API Ëé∑ÂèñÊ®°ÂûãÂàóË°®...
                                    </div>
                                    
                                    <!-- Error message -->
                                    <div x-show="$store.settings.modelsError" 
                                        class="form-help" 
                                        style="color: #FF3B30; margin-top: 8px;">
                                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                                        <span x-text="$store.settings.modelsError"></span>
                                    </div>
                                    
                                    <!-- Success message -->
                                    <div x-show="!$store.settings.modelsError && !$store.settings.modelsLoading && $store.settings.availableModels.length > 0" 
                                        class="form-help" 
                                        style="color: #34C759; margin-top: 8px;">
                                        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
                                        Â∑≤Âä†ËΩΩ <span x-text="$store.settings.availableModels.length"></span> ‰∏™Ê®°Âûã
                                        <span x-show="$store.settings.modelsLastFetch">
                                            (ÁºìÂ≠ò 5 ÂàÜÈíü)
                                        </span>
                                    </div>
                                </div>
                            </template>
                        </div>
                        
                        <template x-if="$store.settings.apiConfig.apiType === 'gemini'">
                            <div class="form-group">
                                <div class="form-help" style="background: #e8f4fd; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                    <p style="margin: 0 0 8px 0; font-weight: 500;">üìã ‰ΩøÁî®ËØ¥ÊòéÔºö</p>
                                    <p style="margin: 0 0 4px 0;">1. ËÆøÈóÆ <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #1976d2;">Google AI Studio</a> Ëé∑ÂèñÂÖçË¥πAPIÂØÜÈí•</p>
                                    <p style="margin: 0 0 4px 0;">2. APIÂØÜÈí•Ê†ºÂºèÔºöAIzaÂºÄÂ§¥ÁöÑÂ≠óÁ¨¶‰∏≤</p>
                                    <p style="margin: 0;">3. Êé®Ëçê‰ΩøÁî®Gemini 2.5</p>
                                </div>
                            </div>
                        </template>
                        <button class="button" @click="saveApiConfig()">‰øùÂ≠òËÆæÁΩÆ</button>
                        
                        <!-- Minimax Voice API Settings Section -->
                        <div class="form-section" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #E5E5EA;">
                            <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1C1C1E;">Minimax ËØ≠Èü≥APIËÆæÁΩÆ</h3>
                            
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" 
                                           x-model="$store.settings.voiceApiConfig.voiceEnabled"
                                           style="width: 18px; height: 18px;">
                                    <span>ÂêØÁî®ËØ≠Èü≥ÂêàÊàêÂäüËÉΩ</span>
                                </label>
                                <small class="form-help">ÂºÄÂêØÂêéÔºåAIÂèëÈÄÅÁöÑËØ≠Èü≥Ê∂àÊÅØÂ∞ÜÂêàÊàê‰∏∫ÁúüÂÆûËØ≠Èü≥</small>
                            </div>
                            
                            <div x-show="$store.settings.voiceApiConfig.voiceEnabled" 
                                 x-transition:enter="transition ease-out duration-300"
                                 x-transition:enter-start="opacity-0 transform -translate-y-2"
                                 x-transition:enter-end="opacity-100 transform translate-y-0"
                                 x-transition:leave="transition ease-in duration-200"
                                 x-transition:leave-start="opacity-100"
                                 x-transition:leave-end="opacity-0">
                                
                                <div class="form-group">
                                    <label class="form-label">API Key <span style="color: #FF3B30;">*</span></label>
                                    <input type="password" 
                                           class="form-input" 
                                           x-model="$store.settings.voiceApiConfig.minimaxApiKey" 
                                           placeholder="ËØ∑ËæìÂÖ•Minimax API Key">
                                    <small class="form-help">‰ªéMinimaxÂπ≥Âè∞Ëé∑ÂèñÁöÑAPIÂØÜÈí•</small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Group ID <span style="color: #FF3B30;">*</span></label>
                                    <input type="text" 
                                           class="form-input" 
                                           x-model="$store.settings.voiceApiConfig.minimaxGroupId" 
                                           placeholder="ËØ∑ËæìÂÖ•Group ID">
                                    <small class="form-help">MinimaxÂπ≥Âè∞Êèê‰æõÁöÑGroup ID</small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">ËØ≠Èü≥Ê®°Âûã</label>
                                    <select class="form-input" x-model="$store.settings.voiceApiConfig.minimaxModel">
                                        <template x-for="model in $store.settings.voiceModels" :key="model.id">
                                            <option :value="model.id" x-text="model.name"></option>
                                        </template>
                                    </select>
                                    <small class="form-help">ÈÄâÊã©ËØ≠Èü≥ÂêàÊàêÊ®°ÂûãÔºåÊé®Ëçê‰ΩøÁî®ÈªòËÆ§ÁöÑ Speech 2.5 HD Preview</small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">ËØ≠Èü≥ËßíËâ≤</label>
                                    <select class="form-input" x-model="$store.settings.voiceApiConfig.voiceId">
                                        <template x-for="voice in $store.settings.voiceCharacters" :key="voice.id">
                                            <option :value="voice.id" x-text="voice.name"></option>
                                        </template>
                                    </select>
                                    <small class="form-help">ÈÄâÊã©ËØ≠Èü≥ËßíËâ≤Ôºå‰∏çÂêåËßíËâ≤Êúâ‰∏çÂêåÁöÑÈü≥Ëâ≤ÁâπÁÇπ</small>
                                </div>
                                
                                <div class="form-help" style="background: #e8f4fd; padding: 12px; border-radius: 8px; margin-top: 16px;">
                                    <p style="margin: 0 0 8px 0; font-weight: 500;">üìã ‰ΩøÁî®ËØ¥ÊòéÔºö</p>
                                    <p style="margin: 0 0 4px 0;">1. ËÆøÈóÆ <a href="https://platform.minimaxi.com" target="_blank" style="color: #1976d2;">MinimaxÂπ≥Âè∞</a> Ëé∑ÂèñAPIÂØÜÈí•ÂíåGroup ID</p>
                                    <p style="margin: 0 0 4px 0;">2. ÂêØÁî®ÂêéÔºåÁÇπÂáªËØ≠Èü≥Ê∂àÊÅØ‰ºöËá™Âä®ÂêàÊàêÂπ∂Êí≠ÊîæÁúüÂÆûËØ≠Èü≥</p>
                                    <p style="margin: 0;">3. Â∑≤ÂêàÊàêÁöÑËØ≠Èü≥‰ºöËá™Âä®ÁºìÂ≠òÔºåÈÅøÂÖçÈáçÂ§çËØ∑Ê±Ç</p>
                                </div>
                            </div>
                            
                            <button class="button" 
                                    style="margin-top: 16px; background: #FF6B35;" 
                                    @click="saveVoiceApiConfig()"
                                    x-show="$store.settings.voiceApiConfig.voiceEnabled">
                                <i class="fas fa-microphone" style="margin-right: 8px;"></i>
                                ‰øùÂ≠òËØ≠Èü≥ËÆæÁΩÆ
                            </button>
                        </div>
                        
                        <!-- Data Management Section -->
                        <div class="form-section" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #E5E5EA;">
                            <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1C1C1E;">Êï∞ÊçÆÁÆ°ÁêÜ</h3>
                            
                            <div class="form-group">
                                <div class="form-help" style="background: #F2F2F7; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                    <p style="margin: 0 0 8px 0; font-weight: 500; color: #1C1C1E;">
                                        <span x-text="$store.app.storageStatus === 'persistent' ? 'üîí Êï∞ÊçÆÂ∑≤ÊåÅ‰πÖÂåñ' : 
                                                     $store.app.storageStatus === 'not-persistent' ? '‚ö†Ô∏è ‰∏¥Êó∂Â≠òÂÇ®Ê®°Âºè' : 
                                                     $store.app.storageStatus === 'not-supported' ? '‚ùå ‰∏çÊîØÊåÅÊåÅ‰πÖÂ≠òÂÇ®' : 'üîÑ Ê£ÄÊü•‰∏≠...'"></span>
                                    </p>
                                    <p style="margin: 0; font-size: 14px; color: #8E8E93;">
                                        <span x-show="$store.app.storageStatus === 'persistent'">ÊÇ®ÁöÑÊï∞ÊçÆÂ∑≤Ëé∑ÂæóÊåÅ‰πÖÂåñ‰øùÊä§Ôºå‰∏ç‰ºöË¢´Ëá™Âä®Ê∏ÖÁêÜ„ÄÇ</span>
                                        <span x-show="$store.app.storageStatus === 'not-persistent'">Âª∫ËÆÆÁî≥ËØ∑ÊåÅ‰πÖÂåñÊùÉÈôêÂπ∂ÂÆöÊúüÂ§á‰ªΩÊï∞ÊçÆ„ÄÇ</span>
                                        <span x-show="$store.app.storageStatus === 'not-supported'">ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÊåÅ‰πÖÂåñÂ≠òÂÇ®ÔºåËØ∑ÂÆöÊúüÂ§á‰ªΩÊï∞ÊçÆ„ÄÇ</span>
                                    </p>
                                </div>
                            </div>
                            
                            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <button class="button" style="background: #34C759;" @click="window.exportData && window.exportData()">
                                    <i class="fas fa-download" style="margin-right: 8px;"></i>
                                    ÂØºÂá∫Êï∞ÊçÆ
                                </button>
                                <button class="button" style="background: #FF9500;" @click="window.importData && window.importData()">
                                    <i class="fas fa-upload" style="margin-right: 8px;"></i>
                                    ÂØºÂÖ•Êï∞ÊçÆ
                                </button>
                            </div>
                            
                            <div class="form-group" x-show="$store.app.storageStatus !== 'persistent'">
                                <button class="button" style="background: #007AFF;" @click="$store.app.requestPersistentStorage().then(granted => {
                                    if (granted) {
                                        alert('‚úÖ Â∑≤Ëé∑ÂæóÊåÅ‰πÖÂåñÂ≠òÂÇ®ÊùÉÈôêÔºÅ');
                                    } else {
                                        alert('‚ö†Ô∏è Êú™ËÉΩËé∑ÂæóÊåÅ‰πÖÂåñÂ≠òÂÇ®ÊùÉÈôê„ÄÇÊÇ®ÁöÑÊï∞ÊçÆ‰ªçÂèØÊ≠£Â∏∏‰ΩøÁî®Ôºå‰ΩÜÂª∫ËÆÆÂÆöÊúüÂ§á‰ªΩ„ÄÇ');
                                    }
                                })">
                                    <i class="fas fa-shield-alt" style="margin-right: 8px;"></i>
                                    Áî≥ËØ∑Êï∞ÊçÆÊåÅ‰πÖÂåñ
                                </button>
                            </div>
                            
                            <template x-if="location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.port">
                                <div class="form-group" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E5E5EA;">
                                    <button class="button" style="background: #FF3B30;" @click="window.resetDatabase && window.resetDatabase()">
                                        <i class="fas fa-trash" style="margin-right: 8px;"></i>
                                        ÈáçÁΩÆÊï∞ÊçÆÂ∫ì (ÂºÄÂèëÊ®°Âºè)
                                    </button>
                                </div>
                            </template>
                        </div>
                        
                        <!-- Theme Settings Section -->
                        <div class="form-section" style="margin-top: 32px; padding-top: 24px; border-top: 1px solid #E5E5EA;">
                            <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #1C1C1E;">ËÅäÂ§©‰∏ªÈ¢òËÆæÁΩÆ</h3>
                            
                            <div class="form-group">
                                <div class="form-help" style="background: #F2F2F7; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                    <p style="margin: 0 0 8px 0; font-weight: 500; color: #1C1C1E;">üé® Ëá™ÂÆö‰πâËÅäÂ§©Ê∞îÊ≥°Ê†∑Âºè</p>
                                    <p style="margin: 0; font-size: 14px; color: #8E8E93;">
                                        ÊîØÊåÅÂºÄÊ∫êÁ§æÂå∫ÁöÑCSS‰ª£Á†ÅÔºåÂèØ‰ª•Ëá™ÂÆö‰πâËÅäÂ§©Ê∞îÊ≥°ÁöÑÊ†∑Âºè„ÄÅÈ¢úËâ≤„ÄÅÂä®ÁîªÁ≠âÊïàÊûú„ÄÇ
                                    </p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Ëá™ÂÆö‰πâCSS‰ª£Á†Å</label>
                                <textarea 
                                    class="form-input" 
                                    x-model="$store.app.globalSettings.customCSS" 
                                    placeholder="/* Âú®ËøôÈáåÁ≤òË¥¥Ëá™ÂÆö‰πâCSS‰ª£Á†Å */&#10;&#10;/* Á§∫‰æãÔºöÊºÇÊµÆÂä®ÁîªÊ∞îÊ≥° */&#10;@keyframes bubble-float {&#10;  0%, 100% { transform: translateY(0); }&#10;  50% { transform: translateY(-4px); }&#10;}&#10;&#10;.message-bubble.user .content {&#10;  background: rgba(220, 230, 225, 1);&#10;  color: #4a5550;&#10;  border-radius: 18px;&#10;  animation: bubble-float 2.5s ease-in-out infinite;&#10;}"
                                    rows="8"
                                    style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 12px; line-height: 1.4;">
                                </textarea>
                                <small class="form-help">
                                    ÊîØÊåÅ .message-bubble.user Âíå .message-bubble.ai ÈÄâÊã©Âô®ÔºåÂÖºÂÆπÂºÄÊ∫êÁ§æÂå∫CSS‰ª£Á†Å„ÄÇ
                                </small>
                            </div>
                            
                            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                                <button class="button" 
                                        :style="$store.app.customCSSSaved ? 'background: #34C759;' : 'background: #007AFF;'"
                                        @click="$store.app.saveCustomCSS($store.app.globalSettings.customCSS)"
                                        :disabled="$store.app.customCSSSaving"
                                        style="font-size: 13px; padding: 8px 10px;">
                                    <template x-if="$store.app.customCSSSaving">
                                        <i class="fas fa-spinner fa-spin" style="margin-right: 6px;"></i>
                                    </template>
                                    <template x-if="!$store.app.customCSSSaving && $store.app.customCSSSaved">
                                        <i class="fas fa-check" style="margin-right: 6px;"></i>
                                    </template>
                                    <template x-if="!$store.app.customCSSSaving && !$store.app.customCSSSaved">
                                        <i class="fas fa-save" style="margin-right: 6px;"></i>
                                    </template>
                                    <span x-text="$store.app.customCSSSaving ? '‰øùÂ≠ò‰∏≠' : ($store.app.customCSSSaved ? 'Â∑≤‰øùÂ≠ò' : '‰øùÂ≠òÂ∫îÁî®')"></span>
                                </button>
                                <button class="button" style="background: #FF9500; font-size: 13px; padding: 8px 10px;" @click="
                                    $store.app.globalSettings.customCSS = '';
                                    $store.app.saveCustomCSS('');
                                ">
                                    <i class="fas fa-undo" style="margin-right: 6px;"></i>
                                    ÈáçÁΩÆÊ†∑Âºè
                                </button>
                                <button class="button" style="background: #34C759; font-size: 13px; padding: 8px 10px;" @click="
                                    $store.app.globalSettings.customCSS = `/* ÊºÇÊµÆÂä®Áîª */
@keyframes bubble-float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}

/* Áî®Êà∑Ê∂àÊÅØÊ∞îÊ≥°Ê†∑Âºè */
.message-bubble.user .content {
  position: relative;
  overflow: hidden;
  background: rgba(220, 230, 225, 1);
  color: #4a5550;
  border-radius: 18px;
  padding: 8px 12px;
  box-shadow: 0px 4px 12px 0px rgba(0, 0, 0, 0.08);
  animation: bubble-float 2.5s ease-in-out infinite;
}

/* AIÂõûÂ§çÊ∞îÊ≥°Ê†∑Âºè */
.message-bubble.ai .content {
  background: rgba(255, 255, 255, 0.9);
  color: #333;
  border-radius: 18px;
  box-shadow: 0px 2px 8px 0px rgba(0, 0, 0, 0.1);
}`;
                                ">
                                    <i class="fas fa-magic" style="margin-right: 6px;"></i>
                                    Á§∫‰æãÊ†∑Âºè
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- World Book Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'world-book' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">‰∏ñÁïå‰π¶</div>
                        <button class="header-button" @click="$dispatch('open-create-world-book')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="content">
                        <!-- Selection controls -->
                        <div x-show="$store.worldBook.books.length > 0" class="selection-controls">
                            <button class="button secondary small" @click="$store.worldBook.selectAll()">
                                <i class="fas fa-check-square"></i> ÂÖ®ÈÄâ
                            </button>
                            <button class="button secondary small" @click="$store.worldBook.deselectAll()">
                                <i class="fas fa-square"></i> ÂÖ®‰∏çÈÄâ
                            </button>
                            <span class="enabled-count" x-text="`Â∑≤ÂêØÁî®: ${$store.worldBook.books.filter(b => b.enabled).length} / ${$store.worldBook.books.length}`"></span>
                        </div>
                        
                        <div class="list-container" x-show="$store.worldBook.books.length > 0">
                            <template x-for="book in $store.worldBook.books" :key="book.id">
                                <div class="list-item world-book-item">
                                    <div class="world-book-checkbox">
                                        <input type="checkbox" 
                                               :checked="book.enabled" 
                                               @change="$store.worldBook.toggleBook(book.id)"
                                               :id="'book-' + book.id">
                                        <label :for="'book-' + book.id"></label>
                                    </div>
                                    <div class="list-item-content" @click="editWorldBook(book.id)">
                                        <div class="list-item-title" x-text="book.name"></div>
                                        <div class="list-item-subtitle" x-text="book.content ? (book.content.substring(0, 50) + (book.content.length > 50 ? '...' : '')) : 'ÊöÇÊó†ÂÜÖÂÆπ'"></div>
                                    </div>
                                    <div class="world-book-actions">
                                        <button class="action-btn edit-btn" @click="editWorldBook(book.id)" title="ÁºñËæë">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="action-btn delete-btn" @click="
                                            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∏ñÁïå‰π¶ÂêóÔºü')) {
                                                $store.worldBook.deleteBook(book.id);
                                                showMessage('‰∏ñÁïå‰π¶Â∑≤Âà†Èô§');
                                            }
                                        " title="Âà†Èô§">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div x-show="$store.worldBook.books.length === 0" class="text-center p-4">
                            <p class="text-secondary">ÊöÇÊó†‰∏ñÁïå‰π¶</p>
                            <button class="button mt-4" @click="$dispatch('open-create-world-book')">ÂàõÂª∫‰∏ñÁïå‰π¶</button>
                        </div>
                    </div>
                </div>


                <!-- Personas Page -->
                <div class="page" :class="{ active: $store.app.currentPage === 'personas' }">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">ÈÄöËÆØÂΩï</div>
                        <button class="header-button" @click="$dispatch('open-create-persona')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div class="content">
                        <div class="personas-list">
                            <template x-for="persona in $store.personas.personas" :key="persona.id">
                                <div class="persona-item">
                                    <div class="persona-avatar">
                                        <img :src="persona.avatar" :alt="persona.name" />
                                    </div>
                                    <div class="persona-info">
                                        <div class="persona-name" x-text="persona.name"></div>
                                        <div class="persona-preview" x-text="persona.persona.slice(0, 50) + (persona.persona.length > 50 ? '...' : '')"></div>
                                    </div>
                                    <div class="persona-actions">
                                        <button class="edit-button" @click="$dispatch('edit-persona', persona)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="delete-button" @click="
                                            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§„Äå${persona.name}„ÄçÂêóÔºü\n\n‚ö†Ô∏è Ê≥®ÊÑèÔºö\n‚Ä¢ Â∞ÜÂà†Èô§ÊâÄÊúâ‰∏éËØ•ËßíËâ≤ÁöÑÁßÅËÅäËÆ∞ÂΩï\n‚Ä¢ ËØ•ËßíËâ≤Â∞Ü‰ªéÊâÄÊúâÁæ§ËÅä‰∏≠ÁßªÈô§\n‚Ä¢ Ê≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç`)) {
                                                $store.personas.deletePersona(persona.id);
                                            }
                                        ">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                            
                            <div x-show="$store.personas.personas.length === 0" class="empty-state">
                                <i class="fas fa-user-friends empty-icon"></i>
                                <div class="empty-title">ÊöÇÊó†‰∫∫ËÆæ</div>
                                <div class="empty-subtitle">ÁÇπÂáªÂè≥‰∏äËßí + ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™‰∫∫ËÆæ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Moments Page -->
                <div class="page moments-page" :class="{ active: $store.app.currentPage === 'moments' }" x-data="momentsInterface()">
                    <div class="header">
                        <button class="header-button" @click="navigateTo('home')">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="header-title">ÊúãÂèãÂúà</div>
                        <button class="header-button" @click="showCreateMoment()">
                            <i class="fas fa-camera"></i>
                        </button>
                    </div>
                    
                    <!-- Moments Feed -->
                    <div class="moments-feed" x-ref="momentsContainer">
                        <template x-for="moment in $store.moments.moments" :key="moment.id">
                            <div class="moment-item">
                                <!-- User Info -->
                                <div class="moment-header">
                                    <div class="moment-avatar" x-text="moment.userAvatar"></div>
                                    <div class="moment-user-info">
                                        <div class="moment-username" x-text="moment.userName"></div>
                                        <div class="moment-time" x-text="$store.moments.formatTime(moment.timestamp)"></div>
                                        <div x-show="moment.location" class="moment-location" x-text="moment.location"></div>
                                    </div>
                                </div>
                                
                                <!-- Content -->
                                <div class="moment-content">
                                    <div x-show="moment.content" class="moment-text" x-text="moment.content"></div>
                                    
                                    <!-- Images Grid -->
                                    <div x-show="moment.images && moment.images.length > 0" class="moment-images" :class="'images-' + moment.images.length">
                                        <template x-for="(image, index) in moment.images" :key="index">
                                            <div class="moment-image">
                                                <img :src="image" :alt="'ÂõæÁâá' + (index + 1)" @click="showImage(image)">
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <div class="moment-actions">
                                    <button class="action-button" @click="$store.moments.toggleLike(moment.id)" 
                                            :class="{ liked: $store.moments.isLikedByUser(moment.id) }">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                    <button class="action-button" @click="showCommentInput(moment.id)">
                                        <i class="fas fa-comment"></i>
                                    </button>
                                </div>
                                
                                <!-- Likes and Comments Info -->
                                <div class="moment-stats">
                                    <div x-show="$store.moments.getMomentsLikes(moment.id).length > 0" class="likes-info">
                                        <i class="fas fa-heart"></i>
                                        <span x-text="$store.moments.getMomentsLikes(moment.id).map(l => l.userName).join(', ')"></span>
                                    </div>
                                </div>
                                
                                <!-- Comments -->
                                <div x-show="$store.moments.getMomentsComments(moment.id).length > 0" class="moment-comments">
                                    <template x-for="comment in $store.moments.getMomentsComments(moment.id)" :key="comment.id">
                                        <div class="comment-item">
                                            <span class="comment-user" x-text="comment.userName"></span>
                                            <span x-show="comment.replyTo" class="comment-reply">ÂõûÂ§ç<span x-text="comment.replyTo"></span></span>
                                            <span class="comment-content" x-text="comment.content"></span>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Comment Input -->
                                <div x-show="activeCommentInput === moment.id" class="comment-input-container">
                                    <input type="text" x-model="commentText" 
                                           :placeholder="'ËØÑËÆ∫' + moment.userName + '...'"
                                           @keydown.enter="submitComment(moment.id)"
                                           class="comment-input">
                                    <button @click="submitComment(moment.id)" class="comment-submit">ÂèëÈÄÅ</button>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Empty State -->
                        <div x-show="$store.moments.moments.length === 0" class="empty-state">
                            <i class="fas fa-heart-broken"></i>
                            <p>ËøòÊ≤°ÊúâÊúãÂèãÂúàÂä®ÊÄÅ</p>
                            <button class="button" @click="showCreateMoment()">ÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°ÊúãÂèãÂúà</button>
                        </div>
                    </div>
                    
                    <!-- Create Moment Modal -->
                    <div x-show="$store.moments.showCreateModal" class="modal-overlay" @click="hideCreateMoment()">
                        <div class="modal" @click.stop>
                            <div class="modal-header">
                                <button @click="hideCreateMoment()">ÂèñÊ∂à</button>
                                <span>ÂèëÊúãÂèãÂúà</span>
                                <button @click="publishMoment()" :disabled="!newMomentContent.trim()">ÂèëË°®</button>
                            </div>
                            <div class="modal-content">
                                <textarea x-model="newMomentContent" 
                                         placeholder="Ëøô‰∏ÄÂàªÁöÑÊÉ≥Ê≥ï..." 
                                         class="moment-textarea"
                                         rows="6"></textarea>
                                
                                <!-- Local Image Upload -->
                                <div class="image-input-section">
                                    <label>Ê∑ªÂä†ÂõæÁâá (ÂèØÈÄâ)</label>
                                    <div>
                                        <input type="file" 
                                               accept="image/*" 
                                               @change="handleImageUpload($event)"
                                               class="image-file-input"
                                               style="display: none;"
                                               x-ref="imageInput">
                                        <button @click="$refs.imageInput.click()" class="upload-button">
                                            <i class="fas fa-camera"></i> ÈÄâÊã©ÂõæÁâá
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Preview Images -->
                                <div x-show="newMomentImages.length > 0" class="preview-images">
                                    <template x-for="(image, index) in newMomentImages" :key="index">
                                        <div class="preview-image">
                                            <img :src="image" :alt="'È¢ÑËßà' + (index + 1)">
                                            <button @click="removeImage(index)" class="remove-image">√ó</button>
                                        </div>
                                    </template>
                                </div>
                                
                                <!-- Location Input -->
                                <div class="location-input-section">
                                    <input type="text" x-model="newMomentLocation" 
                                           placeholder="ÊâÄÂú®‰ΩçÁΩÆ (ÂèØÈÄâ)..." 
                                           class="location-input">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Chat Modal -->
        <div class="modal" :class="{ active: showCreateChatModal }" 
             x-data="{
                 showCreateChatModal: false,
                 selectedPersonaId: '',
                 selectedPersona: null,
                 init() {
                     console.log('Create Chat Modal initialized:', this.showCreateChatModal);
                 }
             }"
             @open-create-chat.window="
                 selectedPersonaId = ''; 
                 selectedPersona = null; 
                 showCreateChatModal = true;
                 console.log('Opening create chat modal');
             ">
            <div class="modal-overlay" @click="showCreateChatModal = false"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ÂàõÂª∫ÁßÅËÅä</h3>
                    <button class="close-button" @click="showCreateChatModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Empty state when no personas exist -->
                    <div x-show="$store.personas.personas.length === 0" class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div class="empty-state-message">
                            <h4>ËøòÊ≤°ÊúâËßíËâ≤ÂèØÁî®</h4>
                            <p>ËØ∑ÂÖàÂàõÂª∫ËßíËâ≤ÊâçËÉΩÂºÄÂßãÁßÅËÅä</p>
                        </div>
                        <button class="button primary" @click="showCreateChatModal = false; $store.app.navigateTo('personas')">
                            ÂâçÂæÄÈÄöËÆØÂΩïÂàõÂª∫ËßíËâ≤
                        </button>
                    </div>
                    
                    <!-- Normal persona selection when personas exist -->
                    <div x-show="$store.personas.personas.length > 0" class="form-group">
                        <label>ÈÄâÊã©‰∫∫ËÆæ</label>
                        <div class="persona-selector">
                            <template x-for="persona in $store.personas.personas" :key="persona.id">
                                <div class="persona-option" 
                                     :class="{ selected: selectedPersonaId === persona.id }"
                                     @click="selectedPersonaId = persona.id; selectedPersona = persona;">
                                    <div class="persona-avatar">
                                        <img :src="persona.avatar" :alt="persona.name" />
                                    </div>
                                    <div class="persona-name" x-text="persona.name"></div>
                                </div>
                            </template>
                        </div>
                        <div x-show="selectedPersona" class="selected-persona-preview">
                            <strong>ÈÄâ‰∏≠ÁöÑ‰∫∫ËÆæÔºö</strong>
                            <p x-text="selectedPersona?.persona"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" @click="showCreateChatModal = false">ÂèñÊ∂à</button>
                    <button x-show="$store.personas.personas.length > 0" class="button primary" @click="
                        if (!selectedPersona) { 
                            alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™‰∫∫ËÆæ'); 
                            return; 
                        }
                        $store.chat.createChat(selectedPersona.name, 'single', selectedPersona.persona, selectedPersona.id, selectedPersona.avatar).then(chatId => {
                            $store.chat.currentMessages = []; // Ê∏ÖÁ©∫ÂΩìÂâçÊ∂àÊÅØÈÅøÂÖç‰∏≤Êâ∞
                            $store.app.navigateTo('chat', { chatId });
                            showCreateChatModal = false;
                        });
                    ">ÂàõÂª∫</button>
                </div>
            </div>
        </div>

        <!-- Create Group Chat Modal -->
        <div class="modal" :class="{ active: showGroupChatModal }"
             x-data="{
                 showGroupChatModal: false,
                 groupName: '',
                 selectedPersonaIds: [],
                 init() {
                     console.log('Group Chat Modal initialized');
                 },
                 togglePersona(personaId) {
                     const index = this.selectedPersonaIds.indexOf(personaId);
                     if (index > -1) {
                         this.selectedPersonaIds.splice(index, 1);
                     } else {
                         this.selectedPersonaIds.push(personaId);
                     }
                 },
                 isSelected(personaId) {
                     return this.selectedPersonaIds.includes(personaId);
                 },
                 getSelectedPersonas() {
                     return $store.personas.personas.filter(p => this.selectedPersonaIds.includes(p.id));
                 }
             }"
             @open-create-group-chat.window="
                 groupName = '';
                 selectedPersonaIds = [];
                 showGroupChatModal = true;
             ">
            <div class="modal-overlay" @click="showGroupChatModal = false"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ÂàõÂª∫Áæ§ËÅä</h3>
                    <button class="close-button" @click="showGroupChatModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Áæ§ËÅäÂêçÁß∞</label>
                        <input type="text" 
                               x-model="groupName" 
                               placeholder="ËØ∑ËæìÂÖ•Áæ§ËÅäÂêçÁß∞"
                               class="form-input">
                    </div>
                    
                    <!-- Empty state when no personas exist -->
                    <div x-show="$store.personas.personas.length === 0" class="form-group">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="empty-state-message">
                                <h4>ËøòÊ≤°ÊúâËßíËâ≤ÂèØÁî®</h4>
                                <p>ËØ∑ÂÖàÂàõÂª∫Ëá≥Â∞ë‰∏§‰∏™ËßíËâ≤ÊâçËÉΩÂºÄÂßãÁæ§ËÅä</p>
                            </div>
                            <button class="button primary" @click="showGroupChatModal = false; $store.app.navigateTo('personas')">
                                ÂâçÂæÄÈÄöËÆØÂΩïÂàõÂª∫ËßíËâ≤
                            </button>
                        </div>
                    </div>
                    
                    <!-- Insufficient personas state when only 1 persona exists -->
                    <div x-show="$store.personas.personas.length === 1" class="form-group">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="empty-state-message">
                                <h4>ËßíËâ≤Êï∞Èáè‰∏çË∂≥</h4>
                                <p>Áæ§ËÅäÈúÄË¶ÅËá≥Â∞ë‰∏§‰∏™ËßíËâ≤ÔºåËØ∑ÂÜçÂàõÂª∫‰∏Ä‰∏™ËßíËâ≤</p>
                            </div>
                            <button class="button primary" @click="showGroupChatModal = false; $store.app.navigateTo('personas')">
                                ÂâçÂæÄÈÄöËÆØÂΩïÂàõÂª∫ËßíËâ≤
                            </button>
                        </div>
                    </div>
                    
                    <!-- Normal group member selection when sufficient personas exist -->
                    <div x-show="$store.personas.personas.length >= 2" class="form-group">
                        <label>ÈÄâÊã©Áæ§ÊàêÂëò <span class="text-secondary">(Ëá≥Â∞ëÈÄâÊã©2‰∏™)</span></label>
                        <div class="persona-grid">
                            <template x-for="persona in $store.personas.personas" :key="persona.id">
                                <div class="persona-checkbox-item" 
                                     :class="{ 'selected': isSelected(persona.id) }"
                                     @click="togglePersona(persona.id)">
                                    <div class="persona-checkbox">
                                        <input type="checkbox" 
                                               :checked="isSelected(persona.id)"
                                               @click.stop
                                               @change="togglePersona(persona.id)">
                                    </div>
                                    <div class="persona-mini-avatar">
                                        <img :src="persona.avatar" :alt="persona.name">
                                    </div>
                                    <div class="persona-mini-name" x-text="persona.name"></div>
                                </div>
                            </template>
                        </div>
                        
                        <div x-show="selectedPersonaIds.length > 0" class="selected-members-preview">
                            <strong>Â∑≤ÈÄâÊã© <span x-text="selectedPersonaIds.length"></span> ‰∏™ÊàêÂëòÔºö</strong>
                            <div class="selected-members-list">
                                <template x-for="persona in getSelectedPersonas()" :key="persona.id">
                                    <span class="member-tag">
                                        <span x-text="persona.name"></span>
                                        <button @click="togglePersona(persona.id)" class="remove-tag">√ó</button>
                                    </span>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" @click="showGroupChatModal = false">ÂèñÊ∂à</button>
                    <button x-show="$store.personas.personas.length >= 2" class="button primary" 
                            :disabled="!groupName.trim() || selectedPersonaIds.length < 2"
                            @click="
                                if (!groupName.trim()) {
                                    alert('ËØ∑ËæìÂÖ•Áæ§ËÅäÂêçÁß∞');
                                    return;
                                }
                                if (selectedPersonaIds.length < 2) {
                                    alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©2‰∏™Áæ§ÊàêÂëò');
                                    return;
                                }
                                const selectedPersonas = getSelectedPersonas();
                                $store.chat.createGroupChat(groupName.trim(), selectedPersonaIds, selectedPersonas).then(chatId => {
                                    if (chatId) {
                                        $store.chat.currentMessages = [];
                                        $store.app.navigateTo('chat', { chatId });
                                        showGroupChatModal = false;
                                    }
                                });
                            ">ÂàõÂª∫Áæ§ËÅä</button>
                </div>
            </div>
        </div>

        <!-- Persona Edit Modal -->
        <div class="modal" :class="{ active: showPersonaModal }" 
             x-data="{ 
                 showPersonaModal: false, 
                 editingPersonaId: null,
                 personaName: '',
                 personaAvatar: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNFNUU1RUEiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzk5OTk5OSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPgo8cGF0aCBkPSJtMjAgMjEtMTYtMTZtMCAwIDMuNSAzLjVNMTcgMTcuNSA2IDciLz4KPHN2Zz4KPC9zdmc+Cjwvc3ZnPgo=',
                 personaText: '',
                 personaMemory: '',
                 init() {
                     console.log('Persona Modal initialized:', this.showPersonaModal);
                 },
                 async handleAvatarUpload(event) {
                     const file = event.target.files[0];
                     if (!file) return;
                     
                     try {
                         const base64 = await window.fileToBase64(file);
                         this.personaAvatar = base64;
                         event.target.value = '';
                     } catch (error) {
                         alert(error.message);
                     }
                 }
             }"
             @open-create-persona.window="
                 editingPersonaId = null;
                 personaName = '';
                 personaAvatar = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiNFNUU1RUEiLz4KPHN2ZyB4PSIyMCIgeT0iMjAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIj4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzk5OTk5OSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPgo8cGF0aCBkPSJtMjAgMjEtMTYtMTZtMCAwIDMuNSAzLjVNMTcgMTcuNSA2IDciLz4KPHN2Zz4KPC9zdmc+Cjwvc3ZnPgo=';
                 personaText = '';
                 personaMemory = '';
                 showPersonaModal = true;
             "
             @edit-persona.window="
                 editingPersonaId = $event.detail.id;
                 personaName = $event.detail.name;
                 personaAvatar = $event.detail.avatar;
                 personaText = $event.detail.persona;
                 personaMemory = $event.detail.memory || '';
                 showPersonaModal = true;
             ">
            <div class="modal-overlay" @click="showPersonaModal = false"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 x-text="editingPersonaId ? 'ÁºñËæë‰∫∫ËÆæ' : 'ÂàõÂª∫‰∫∫ËÆæ'"></h3>
                    <button class="close-button" @click="showPersonaModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>‰∫∫ËÆæÂêçÁß∞</label>
                        <input type="text" x-model="personaName" placeholder="ËØ∑ËæìÂÖ•‰∫∫ËÆæÂêçÁß∞" />
                    </div>
                    <div class="form-group">
                        <label>Â§¥ÂÉè</label>
                        <div class="avatar-upload-section">
                            <div class="avatar-preview">
                                <img :src="personaAvatar" :alt="personaName" class="preview-avatar" />
                            </div>
                            <div class="avatar-upload-controls">
                                <input type="file" 
                                       accept="image/*" 
                                       @change="handleAvatarUpload($event)"
                                       class="avatar-file-input"
                                       style="display: none;"
                                       x-ref="avatarInput">
                                <button @click="$refs.avatarInput.click()" class="upload-button">
                                    <i class="fas fa-camera"></i> ÈÄâÊã©Â§¥ÂÉè
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>‰∫∫ËÆæÊèèËø∞</label>
                        <textarea x-model="personaText" rows="6" placeholder="ËØ∑ËæìÂÖ•ËØ¶ÁªÜÁöÑ‰∫∫ËÆæÊèèËø∞..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>ÈïøÊúüËÆ∞ÂøÜ</label>
                        <textarea x-model="personaMemory" rows="6" placeholder="ËßíËâ≤ÁöÑÈïøÊúüËÆ∞ÂøÜÔºåÊØèÊù°ËÆ∞ÂøÜ‰∏ÄË°å..."></textarea>
                        <br/>
                        <small style="color: #888; font-size: 12px;">ËøôÈáåÁöÑÂÜÖÂÆπ‰ºöÂú®ÊØèÊ¨°ÂØπËØùÊó∂Êèê‰æõÁªôËßíËâ≤ÔºåAI‰πü‰ºöËá™Âä®Ê∑ªÂä†Êñ∞ÁöÑËÆ∞ÂøÜ</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" @click="showPersonaModal = false">ÂèñÊ∂à</button>
                    <button class="button primary" @click="
                        if (!personaName.trim()) {
                            alert('ËØ∑ËæìÂÖ•‰∫∫ËÆæÂêçÁß∞');
                            return;
                        }
                        if (editingPersonaId) {
                            $store.personas.updatePersona(editingPersonaId, {
                                name: personaName.trim(),
                                avatar: personaAvatar,
                                persona: personaText.trim(),
                                memory: personaMemory.trim()
                            }).then(() => { showPersonaModal = false; });
                        } else {
                            $store.personas.createPersona(
                                personaName.trim(),
                                personaAvatar,
                                personaText.trim(),
                                personaMemory.trim()
                            ).then(() => { showPersonaModal = false; });
                        }
                    " x-text="editingPersonaId ? '‰øùÂ≠ò' : 'ÂàõÂª∫'"></button>
                </div>
            </div>
        </div>
        
        <!-- World Book Modal -->
        <div class="modal" :class="{ active: showWorldBookModal }" 
             x-data="{ 
                 showWorldBookModal: false, 
                 editingWorldBookId: null,
                 worldBookName: '',
                 worldBookContent: ''
             }"
             @open-create-world-book.window="
                 editingWorldBookId = null;
                 worldBookName = '';
                 worldBookContent = '';
                 showWorldBookModal = true;
             "
             @edit-world-book.window="
                 editingWorldBookId = $event.detail.id;
                 worldBookName = $event.detail.name;
                 worldBookContent = $event.detail.content;
                 showWorldBookModal = true;
             ">
            <div class="modal-overlay" @click="showWorldBookModal = false"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 x-text="editingWorldBookId ? 'ÁºñËæë‰∏ñÁïå‰π¶' : 'ÂàõÂª∫‰∏ñÁïå‰π¶'"></h3>
                    <button class="close-button" @click="showWorldBookModal = false">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>‰∏ñÁïå‰π¶ÂêçÁß∞</label>
                        <input type="text" x-model="worldBookName" placeholder="ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÂêçÁß∞" />
                    </div>
                    <div class="form-group">
                        <label>‰∏ñÁïå‰π¶ÂÜÖÂÆπ</label>
                        <textarea x-model="worldBookContent" 
                                  rows="10" 
                                  placeholder="ËØ∑ËæìÂÖ•ËØ¶ÁªÜÁöÑ‰∏ñÁïåËÆæÂÆöÂÜÖÂÆπ...ÊîØÊåÅÂ§ßÈáèÊñáÊú¨Âíå Emoji üåü"></textarea>
                        <small class="form-hint">ÊîØÊåÅÊï∞‰∏áÂ≠óÁöÑÂÜÖÂÆπÔºåÂåÖÂê´ Emoji Á≠â UTF-8 Â≠óÁ¨¶</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" @click="showWorldBookModal = false">ÂèñÊ∂à</button>
                    <button class="button primary" @click="
                        if (!worldBookName.trim()) {
                            alert('ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÂêçÁß∞');
                            return;
                        }
                        if (editingWorldBookId) {
                            $store.worldBook.updateBook(editingWorldBookId, {
                                name: worldBookName.trim(),
                                content: worldBookContent.trim()
                            }).then(() => { 
                                showWorldBookModal = false; 
                                showMessage('‰∏ñÁïå‰π¶‰øùÂ≠òÊàêÂäüÔºÅ');
                            });
                        } else {
                            $store.worldBook.createBook(
                                worldBookName.trim(),
                                worldBookContent.trim()
                            ).then(() => { 
                                showWorldBookModal = false; 
                                showMessage('‰∏ñÁïå‰π¶ÂàõÂª∫ÊàêÂäüÔºÅ');
                            });
                        }
                    " x-text="editingWorldBookId ? '‰øùÂ≠ò' : 'ÂàõÂª∫'"></button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js?v=1.18.0"></script>
    <script src="version-update.js?v=1.18.0"></script>
</body>
</html>